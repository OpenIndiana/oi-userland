Backport of:

From e02d7478ebfc399a9d10ba0df60eee217aa7ab8f Mon Sep 17 00:00:00 2001
From: Karl Williamson <khw@cpan.org>
Date: Fri, 2 Feb 2018 15:14:27 -0700
Subject: (perl #132227) restart a node if we change to uni rules within the
 node and encounter a sharp S

This could lead to a buffer overflow.
---
 regcomp.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

Index: perl-5.22.1/regcomp.c
===================================================================
--- perl-5.22.1.orig/regcomp.c	2018-04-05 08:34:26.754116373 -0400
+++ perl-5.22.1/regcomp.c	2018-04-05 08:36:04.470364674 -0400
@@ -12679,6 +12679,18 @@ S_regatom(pTHX_ RExC_state_t *pRExC_stat
                                    && isALPHA_FOLD_EQ(ender, 's')
                                    && isALPHA_FOLD_EQ(*(s-1), 's'))))
                         {
+
+                            /* If the node started out having uni rules, we
+                             * wouldn't have gotten here.  So this means
+                             * something in the middle has changed it, but
+                             * didn't think it needed to reparse.  But this
+                             * sharp s now does indicate the need for
+                             * reparsing. */
+                            if (RExC_uni_semantics) {
+                                p = oldp;
+                                goto loopdone;
+                            }
+
                             maybe_exactfu = FALSE;
                         }
                     }
