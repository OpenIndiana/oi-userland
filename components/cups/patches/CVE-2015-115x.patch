## str4609-prevent-privilege-escalation-through-dynamic-linker.dpatch by Michael Sweet <msweet@apple.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Description: Fix privilege escalation through dynamic linker and isolated vulnerabilities
## DP: Author: Michael Sweet <msweet@apple.com>
## DP: Origin: vendor
## DP: Bug: https://cups.org/str.php?L4609
## DP: Bug-CERT-VN: VU#810572
## DP: Bug-CVE: CVE-2015-1158 - Improper Update of Reference Count
## DP: Bug-CVE: CVE-2015-1159 - Cross-Site Scripting
## DP: Last-Update: 2015-06-09

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups~/cgi-bin/ipp-var.c cups/cgi-bin/ipp-var.c
--- cgi-bin/ipp-var.c	2015-05-26 08:49:44.000000000 +0200
+++ cgi-bin/ipp-var.c	2015-05-26 08:52:16.347344115 +0200
@@ -1226,21 +1226,7 @@
 	      * Rewrite URIs...
 	      */
 
-              if (!strcmp(name, "member_uris"))
-	      {
-		char	url[1024];	/* URL for class member... */
-
-
-		cgiRewriteURL(attr->values[i].string.text, url,
-		              sizeof(url), NULL);
-
-                snprintf(valptr, sizeof(value) - (valptr - value),
-		         "<A HREF=\"%s\">%s</A>", url,
-			 strrchr(attr->values[i].string.text, '/') + 1);
-	      }
-	      else
-		cgiRewriteURL(attr->values[i].string.text, valptr,
-		              sizeof(value) - (valptr - value), NULL);
+	      cgiRewriteURL(attr->values[i].string.text, valptr, sizeof(value) - (valptr - value), NULL);
               break;
             }
 
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups~/cgi-bin/template.c cups/cgi-bin/template.c
--- cgi-bin/template.c	2015-05-26 08:49:44.000000000 +0200
+++ cgi-bin/template.c	2015-05-26 08:52:16.347344115 +0200
@@ -659,39 +659,7 @@
   while (*s)
   {
     if (*s == '<')
-    {
-     /*
-      * Pass <A HREF="url"> and </A>, otherwise quote it...
-      */
-
-      if (!strncasecmp(s, "<A HREF=\"", 9))
-      {
-        fputs("<A HREF=\"", out);
-	s += 9;
-
-	while (*s && *s != '\"')
-	{
-          if (*s == '&')
-            fputs("&amp;", out);
-	  else
-	    putc(*s, out);
-
-	  s ++;
-	}
-
-        if (*s)
-	  s ++;
-
-	fputs("\">", out);
-      }
-      else if (!strncasecmp(s, "</A>", 4))
-      {
-        fputs("</A>", out);
-	s += 3;
-      }
-      else
-        fputs("&lt;", out);
-    }
+      fputs("&lt;", out);
     else if (*s == '>')
       fputs("&gt;", out);
     else if (*s == '\"')
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups~/scheduler/ipp.c cups/scheduler/ipp.c
--- scheduler/ipp.c	2015-05-26 08:49:45.000000000 +0200
+++ scheduler/ipp.c	2015-05-26 08:52:16.351344115 +0200
@@ -498,8 +498,8 @@
 	    * Remote unauthenticated user masquerading as local root...
 	    */
 
-	    _cupsStrFree(username->values[0].string.text);
-	    username->values[0].string.text = _cupsStrAlloc(RemoteRoot);
+            _cupsStrFree(username->values[0].string.text);
+            username->values[0].string.text = _cupsStrAlloc(RemoteRoot);
 	  }
 	}
 
@@ -1651,7 +1651,10 @@
     cupsdSetString(&job->username, con->username);
 
     if (attr)
-      cupsdSetString(&attr->values[0].string.text, con->username);
+    {
+      _cupsStrFree(attr->values[0].string.text);
+      attr->values[0].string.text = _cupsStrAlloc(con->username);
+    }
   }
   else if (attr)
   {
@@ -1780,48 +1783,11 @@
       * Also, we can only have 1 value and it must be a name value.
       */
 
-      switch (attr->value_tag)
-      {
-        case IPP_TAG_STRING :
-	case IPP_TAG_TEXTLANG :
-	case IPP_TAG_NAMELANG :
-	case IPP_TAG_TEXT :
-	case IPP_TAG_NAME :
-	case IPP_TAG_KEYWORD :
-	case IPP_TAG_URI :
-	case IPP_TAG_URISCHEME :
-	case IPP_TAG_CHARSET :
-	case IPP_TAG_LANGUAGE :
-	case IPP_TAG_MIMETYPE :
-	   /*
-	    * Free old strings...
-	    */
-
-	    for (i = 0; i < attr->num_values; i ++)
-	    {
-	      _cupsStrFree(attr->values[i].string.text);
-	      attr->values[i].string.text = NULL;
-	      if (attr->values[i].string.charset)
-	      {
-		_cupsStrFree(attr->values[i].string.charset);
-		attr->values[i].string.charset = NULL;
-	      }
-            }
-
-	default :
-            break;
-      }
-
-     /*
-      * Use the default connection hostname instead...
-      */
-
-      attr->value_tag             = IPP_TAG_NAME;
-      attr->num_values            = 1;
-      attr->values[0].string.text = _cupsStrAlloc(con->http.hostname);
-  }
-
-    attr->group_tag = IPP_TAG_JOB;
+      ippDeleteAttribute(job->attrs, attr);
+      ippAddString(job->attrs, IPP_TAG_JOB, IPP_TAG_NAME, "job-originating-host-name", NULL, con->http.hostname);
+     }
+     else 
+       attr->group_tag = IPP_TAG_JOB;
   }
   else
   {
@@ -1835,8 +1801,8 @@
 
       attr = ippAddStrings(job->attrs, IPP_TAG_JOB, IPP_TAG_NAME, "job-sheets",
                            2, NULL, NULL);
-      attr->values[0].string.text = _cupsStrRetain(printer->job_sheets[0]);
-      attr->values[1].string.text = _cupsStrRetain(printer->job_sheets[1]);
+      attr->values[0].string.text = _cupsStrAlloc(printer->job_sheets[0]);
+      attr->values[1].string.text = _cupsStrAlloc(printer->job_sheets[1]);
     }
 
     job->job_sheets = attr;
@@ -1862,7 +1828,8 @@
           * Force the leading banner to have the classification on it...
 	  */
 
-          cupsdSetString(&attr->values[0].string.text, Classification);
+	  _cupsStrFree(attr->values[0].string.text);
+	  attr->values[0].string.text = _cupsStrAlloc(Classification);
 
 	  cupsdLogJob(job, CUPSD_LOG_NOTICE, "CLASSIFICATION FORCED "
 	                		     "job-sheets=\"%s,none\", "
@@ -1879,7 +1846,8 @@
 	  * Can't put two different security markings on the same document!
 	  */
 
-          cupsdSetString(&attr->values[1].string.text, attr->values[0].string.text);
+	  _cupsStrFree(attr->values[1].string.text);
+	  attr->values[1].string.text = _cupsStrAlloc(attr->values[0].string.text);
 
 	  cupsdLogJob(job, CUPSD_LOG_NOTICE, "CLASSIFICATION FORCED "
 	                		     "job-sheets=\"%s,%s\", "
@@ -1919,18 +1887,26 @@
         if (attr->num_values > 1 &&
 	    !strcmp(attr->values[0].string.text, attr->values[1].string.text))
 	{
-          cupsdSetString(&(attr->values[0].string.text), Classification);
-          cupsdSetString(&(attr->values[1].string.text), Classification);
+	  _cupsStrFree(attr->values[0].string.text);
+	  attr->values[0].string.text = _cupsStrAlloc(Classification);
+	  _cupsStrFree(attr->values[1].string.text);
+	  attr->values[1].string.text = _cupsStrAlloc(Classification);
 	}
         else
 	{
           if (attr->num_values == 1 ||
 	      strcmp(attr->values[0].string.text, "none"))
-            cupsdSetString(&(attr->values[0].string.text), Classification);
+	  {
+	    _cupsStrFree(attr->values[0].string.text);
+	    attr->values[0].string.text = _cupsStrAlloc(Classification);
+	  }
 
           if (attr->num_values > 1 &&
 	      strcmp(attr->values[1].string.text, "none"))
-            cupsdSetString(&(attr->values[1].string.text), Classification);
+	  {
+	    _cupsStrFree(attr->values[1].string.text);
+	    attr->values[1].string.text = _cupsStrAlloc(Classification);
+	  }
         }
 
         if (attr->num_values > 1)
@@ -3843,7 +3819,8 @@
   if (attr)
   {
     attr->value_tag = IPP_TAG_KEYWORD;
-    cupsdSetString(&(attr->values[0].string.text), "no-hold");
+    _cupsStrFree(attr->values[0].string.text);
+    attr->values[0].string.text = _cupsStrAlloc("no-hold");
   }
 
  /*
@@ -8809,7 +8786,6 @@
     if (format)
     {
       _cupsStrFree(format->values[0].string.text);
-
       format->values[0].string.text = _cupsStrAlloc(mimetype);
     }
     else
@@ -9348,9 +9324,8 @@
 
   if (attr)
   {
-    _cupsStrFree(attr->values[0].string.text);
-
     attr->value_tag = IPP_TAG_KEYWORD;
+    _cupsStrFree(attr->values[0].string.text);
     attr->values[0].string.text = _cupsStrAlloc("no-hold");
 
     cupsdAddEvent(CUPSD_EVENT_JOB_CONFIG_CHANGED, cupsdFindDest(job->dest), job,
@@ -10041,7 +10016,6 @@
                                     IPP_TAG_MIMETYPE)) != NULL)
     {
       _cupsStrFree(jformat->values[0].string.text);
-
       jformat->values[0].string.text = _cupsStrAlloc(mimetype);
     }
     else
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups~/scheduler/job.c cups/scheduler/job.c
--- scheduler/job.c	2015-05-26 08:49:45.000000000 +0200
+++ scheduler/job.c	2015-05-26 08:52:16.355344115 +0200
@@ -397,7 +397,10 @@
 
           if ((attr = ippFindAttribute(job->attrs, "job-actual-printer-uri",
 	                               IPP_TAG_URI)) != NULL)
-            cupsdSetString(&attr->values[0].string.text, printer->uri);
+          {
+            _cupsStrFree(attr->values[0].string.text);
+            attr->values[0].string.text = _cupsStrAlloc(printer->uri);
+          }
 	  else
 	    ippAddString(job->attrs, IPP_TAG_JOB, IPP_TAG_URI,
 	                 "job-actual-printer-uri", NULL, printer->uri);
@@ -1817,7 +1820,10 @@
 
   if ((attr = ippFindAttribute(job->attrs, "job-printer-uri",
                                IPP_TAG_URI)) != NULL)
-    cupsdSetString(&(attr->values[0].string.text), p->uri);
+  {
+    _cupsStrFree(attr->values[0].string.text);
+    attr->values[0].string.text = _cupsStrAlloc(p->uri);
+  }
 
   cupsdAddEvent(CUPSD_EVENT_JOB_STOPPED, p, job,
                 "Job #%d moved from %s to %s.", job->id, olddest,
@@ -2013,7 +2019,10 @@
       attr = ippFindAttribute(job->attrs, "job-hold-until", IPP_TAG_NAME);
 
     if (attr)
-      cupsdSetString(&(attr->values[0].string.text), when);
+    {
+      _cupsStrFree(attr->values[0].string.text);
+      attr->values[0].string.text = _cupsStrAlloc(when);
+    }
     else
       attr = ippAddString(job->attrs, IPP_TAG_JOB, IPP_TAG_KEYWORD,
                           "job-hold-until", NULL, when);
@@ -2259,7 +2268,8 @@
 	if (attr)
 	{
 	  attr->value_tag = IPP_TAG_KEYWORD;
-	  cupsdSetString(&(attr->values[0].string.text), "no-hold");
+	  _cupsStrFree(attr->values[0].string.text);
+	  attr->values[0].string.text = _cupsStrAlloc("no-hold");
 	}
 
     default :
@@ -3855,7 +3865,10 @@
   job->status_level  = CUPSD_LOG_INFO;
 
   if (job->printer_message)
-    cupsdSetString(&(job->printer_message->values[0].string.text), "");
+  {
+    _cupsStrFree(job->printer_message->values[0].string.text);
+    job->printer_message->values[0].string.text = _cupsStrAlloc("");
+  }
 
  /*
   * Create the backchannel pipes and make them non-blocking...
@@ -4412,10 +4425,15 @@
 
   if (job->state_value != IPP_JOB_PROCESSING &&
       job->status_level == CUPSD_LOG_INFO)
-    cupsdSetString(&(job->printer_message->values[0].string.text), "");
+  {
+    _cupsStrFree(job->printer_message->values[0].string.text);
+    job->printer_message->values[0].string.text = _cupsStrAlloc("");
+  }
   else if (job->printer->state_message[0] && do_message)
-    cupsdSetString(&(job->printer_message->values[0].string.text),
-		   job->printer->state_message);
+  {
+    _cupsStrFree(job->printer_message->values[0].string.text);
+    job->printer_message->values[0].string.text = _cupsStrAlloc(job->printer->state_message);
+  }
 
  /*
   * ... and the printer-state-reasons value...
