#!/sbin/sh

# init.d script to start nut services
# Adapted for OpenIndiana userland from template in the NUT sources
# Adaptation copyright (C) 2016 Jim Klimov

NUT_DIR="@USRDIR@"
NUT_SBIN_DIR="$NUT_DIR/sbin"
#NUT_SBIN_DIR="$NUT_DIR/sbin/@MACH64@"
NUT_RUN_DIR="/@NUTRUNDIR@"
NUTUSER="@NUTUSER@"
NUTGROUP="@NUTGROUP@"
CONFIG="/@NUTETCDIR@/nut.conf"

if [ -f "$CONFIG" ] ; then
	. "$CONFIG"
fi

ups_stop () {
	pkill -n upsmon
	pkill -n upsd
	"${NUT_SBIN_DIR}"/upsdrvctl stop > /dev/null 2>&1
}

ups_start () {
	if [ "$MODE" = "none" ];then
		echo "No NUT mode set" >&2
		exit 1
	fi

	# Default rights inspired by NUT scripts/Solaris/postinstall.in
	mkdir -p "$NUT_RUN_DIR" && \
	chown "root:$NUTGROUP" "$NUT_RUN_DIR" && \
	chmod 770 "$NUT_RUN_DIR" \
	|| exit 1

	if [ ! "$MODE" = "netclient" ];then
		"${NUT_SBIN_DIR}"/upsdrvctl start #> /dev/null 2>&1
		"${NUT_SBIN_DIR}"/upsd #> /dev/null 2>&1
	fi
	"${NUT_SBIN_DIR}"/upsmon #> /dev/null 2>&1
}

case $1 in
'start')
	ups_start
	;;

'stop')
	ups_stop
	;;

'restart')
	ups_stop
	while pgrep upsd > /dev/null
	do
		sleep 1
	done
	ups_start
	;;
'poweroff')
	"${NUT_SBIN_DIR}"/upsmon -K  >/dev/null 2>&1
	if [ $? = 0 ]; then
		echo "Shutting down the UPS ..."
		#"${NUT_SBIN_DIR}"/upsdrvctl shutdown
	fi
	;;
*)
	echo ""
	echo "Usage: '$0' {start | stop | restart }"
	echo ""
	exit 64
	;;

esac
exit $?
