From 0c0b0859ae1aba64861599f0e7f74f143f305932 Mon Sep 17 00:00:00 2001
From: Chris Liddell <chris.liddell@artifex.com>
Date: Tue, 7 Jul 2015 16:57:41 +0100
Subject: [PATCH] Bug 696041: sanity check for memory allocation.

In gs_heap_alloc_bytes(), add a sanity check to ensure we don't overflow the
variable holding the actual number of bytes we allocate.

No cluster differences
---
 gs/base/gsmalloc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: ghostscript-9.05~dfsg/base/gsmalloc.c
===================================================================
--- ghostscript-9.00/base/gsmalloc.c.~1~	2015-08-04 08:36:03.014768523 +0300
+++ ghostscript-9.00/base/gsmalloc.c	2015-08-04 08:41:28.274840262 +0300
@@ -177,7 +177,7 @@
     } else {
 	uint added = size + sizeof(gs_malloc_block_t);
 
-	if (mmem->limit - added < mmem->used)
+	if (added <= size || mmem->limit - added < mmem->used)
 	    set_msg("exceeded limit");
 	else if ((ptr = (byte *) malloc(added)) == 0)
 	    set_msg("failed");
