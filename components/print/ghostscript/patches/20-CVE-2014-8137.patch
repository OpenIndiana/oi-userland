# Description: CVE-2014-8137: double-free in in jas_iccattrval_destroy()
# Origin: vendor, https://bugzilla.redhat.com/attachment.cgi?id=967283,
#  https://bugzilla.redhat.com/attachment.cgi?id=967284
# Bug-Debian: https://bugs.debian.org/773463
# Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=1173157
# Forwarded: no
# Author: Tomas Hoger <thoger@redhat.com>
# Last-Update: 2014-12-20

diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' ghostscript-8.71.dfsg.1~/jasper/src/libjasper/base/jas_icc.c ghostscript-8.71.dfsg.1/jasper/src/libjasper/base/jas_icc.c
--- ghostscript-8.71.dfsg.1~/jasper/src/libjasper/base/jas_icc.c	2015-01-22 13:03:49.000000000 -0500
+++ ghostscript-8.71.dfsg.1/jasper/src/libjasper/base/jas_icc.c	2015-01-22 13:04:20.025580220 -0500
@@ -1023,7 +1023,6 @@
 	return 0;
 
 error:
-	jas_icccurv_destroy(attrval);
 	return -1;
 }
 
@@ -1143,7 +1142,6 @@
 #endif
 	return 0;
 error:
-	jas_icctxtdesc_destroy(attrval);
 	return -1;
 }
 
@@ -1222,8 +1220,6 @@
 		goto error;
 	return 0;
 error:
-	if (txt->string)
-		jas_free(txt->string);
 	return -1;
 }
 
@@ -1348,7 +1344,6 @@
 		goto error;
 	return 0;
 error:
-	jas_icclut8_destroy(attrval);
 	return -1;
 }
 
@@ -1519,7 +1514,6 @@
 		goto error;
 	return 0;
 error:
-	jas_icclut16_destroy(attrval);
 	return -1;
 }
 
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' ghostscript-8.71.dfsg.1~/jasper/src/libjasper/jp2/jp2_dec.c ghostscript-8.71.dfsg.1/jasper/src/libjasper/jp2/jp2_dec.c
--- ghostscript-8.71.dfsg.1~/jasper/src/libjasper/jp2/jp2_dec.c	2015-01-22 13:03:49.000000000 -0500
+++ ghostscript-8.71.dfsg.1/jasper/src/libjasper/jp2/jp2_dec.c	2015-01-22 13:04:20.025580220 -0500
@@ -325,7 +325,10 @@
 	case JP2_COLR_ICC:
 		iccprof = jas_iccprof_createfrombuf(dec->colr->data.colr.iccp,
 		  dec->colr->data.colr.iccplen);
-		assert(iccprof);
+		if (!iccprof) {
+			jas_eprintf("error: failed to parse ICC profile\n");
+			goto error;
+		}
 		jas_iccprof_gethdr(iccprof, &icchdr);
 		if (jas_getdbglevel() >= 1) {
 			jas_eprintf("ICC Profile CS %08x\n", icchdr.colorspc);
