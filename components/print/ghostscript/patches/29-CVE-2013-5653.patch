Description: CVE-2013-5653: Information disclosure through getenv, filenameforall
Origin: backport, http://git.ghostscript.com/?p=ghostpdl.git;a=commit;h=ab109aaeb3ddba59518b036fb288402a65cf7ce8
Bug: http://bugs.ghostscript.com/show_bug.cgi?id=694724
Bug-Debian: https://bugs.debian.org/839118
Forwarded: not-needed
Author: Salvatore Bonaccorso <carnil@debian.org>
Reviewed-by: Emily Ratliff <emily.ratliff@canonical.com>
Last-Update: 2016-11-30
---

--- ghostscript-9.05~dfsg.orig/Resource/Init/gs_init.ps
+++ ghostscript-9.05~dfsg/Resource/Init/gs_init.ps
@@ -2008,6 +2008,7 @@ readonly def
     >> setuserparams
   }
   if
+  systemdict /getenv {pop //false} .forceput
   % setpagedevice has the side effect of clearing the page, but
   % we will just document that. Using setpagedevice keeps the device
   % properties and pagedevice .LockSafetyParams in agreement even
--- ghostscript-9.05~dfsg.orig/psi/zfile.c
+++ ghostscript-9.05~dfsg/psi/zfile.c
@@ -388,22 +388,25 @@ file_continue(i_ctx_t *i_ctx_p)
 
     if (len < devlen)
         return_error(e_rangecheck);     /* not even room for device len */
-    memcpy((char *)pscratch->value.bytes, iodev->dname, devlen);
-    code = iodev->procs.enumerate_next(pfen, (char *)pscratch->value.bytes + devlen,
-                len - devlen);
-    if (code == ~(uint) 0) {    /* all done */
-        esp -= 5;               /* pop proc, pfen, devlen, iodev , mark */
-        return o_pop_estack;
-    } else if (code > len)      /* overran string */
-        return_error(e_rangecheck);
-    else {
-        push(1);
-        ref_assign(op, pscratch);
-        r_set_size(op, code + devlen);
-        push_op_estack(file_continue);  /* come again */
-        *++esp = pscratch[2];   /* proc */
-        return o_push_estack;
-    }
+    do {
+        memcpy((char *)pscratch->value.bytes, iodev->dname, devlen);
+        code = iodev->procs.enumerate_next(pfen, (char *)pscratch->value.bytes + devlen,
+                    len - devlen);
+        if (code == ~(uint) 0) {    /* all done */
+            esp -= 5;               /* pop proc, pfen, devlen, iodev , mark */
+            return o_pop_estack;
+        } else if (code > len)      /* overran string */
+            return_error(e_rangecheck);
+        else if (iodev != iodev_default(imemory)
+              || (check_file_permissions_reduced(i_ctx_p, (char *)pscratch->value.bytes, code + devlen, "PermitFileReading")) == 0) {
+            push(1);
+            ref_assign(op, pscratch);
+            r_set_size(op, code + devlen);
+            push_op_estack(file_continue);  /* come again */
+            *++esp = pscratch[2];   /* proc */
+            return o_push_estack;
+        }
+    } while(1);
 }
 /* Cleanup procedure for enumerating files */
 static int
