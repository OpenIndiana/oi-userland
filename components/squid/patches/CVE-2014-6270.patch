------------------------------------------------------------
revno: 10489
revision-id: squid3@treenet.co.nz-20140915050115-bhutzvtaz6o0bb7g
parent: squid3@treenet.co.nz-20140827144059-65pfjh7kcemvmi51
author: Sebastian Krahmer <krahmer@suse.com>
committer: Amos Jeffries <squid3@treenet.co.nz>
branch nick: SQUID_3_1
timestamp: Sun 2014-09-14 23:01:15 -0600
message:
  Fix off by one in SNMP subsystem
------------------------------------------------------------
# Bazaar merge directive format 2 (Bazaar 0.90)
# revision_id: squid3@treenet.co.nz-20140915050115-bhutzvtaz6o0bb7g
# target_branch: http://bzr.squid-cache.org/bzr/squid3/branches\
#   /SQUID_3_1
# testament_sha1: 5575ce02068e3e6e5091ddedb89042ce02c11085
# timestamp: 2014-09-15 11:10:14 +0000
# source_branch: http://bzr.squid-cache.org/bzr/squid3/branches\
#   /SQUID_3_1
# base_revision_id: squid3@treenet.co.nz-20140827144059-\
#   65pfjh7kcemvmi51
# 
# Begin patch
=== modified file 'src/snmp_core.cc'
--- a/src/snmp_core.cc	2010-08-01 13:29:09 +0000
+++ b/src/snmp_core.cc	2014-09-15 05:01:15 +0000
@@ -418,7 +418,7 @@
 void
 snmpHandleUdp(int sock, void *not_used)
 {
-    LOCAL_ARRAY(char, buf, SNMP_REQUEST_SIZE);
+    static char buf[SNMP_REQUEST_SIZE];
     IpAddress from;
     snmp_request_t *snmp_rq;
     int len;
@@ -427,16 +427,11 @@
 
     commSetSelect(sock, COMM_SELECT_READ, snmpHandleUdp, NULL, 0);
 
-    memset(buf, '\0', SNMP_REQUEST_SIZE);
+    memset(buf, '\0', sizeof(buf));
 
-    len = comm_udp_recvfrom(sock,
-                            buf,
-                            SNMP_REQUEST_SIZE,
-                            0,
-                            from);
+    len = comm_udp_recvfrom(sock, buf, sizeof(buf)-1, 0, from);
 
     if (len > 0) {
-        buf[len] = '\0';
         debugs(49, 3, "snmpHandleUdp: FD " << sock << ": received " << len << " bytes from " << from << ".");
 
         snmp_rq = (snmp_request_t *)xcalloc(1, sizeof(snmp_request_t));

