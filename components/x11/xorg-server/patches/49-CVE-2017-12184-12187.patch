From cad5a1050b7184d828aef9c1dd151c3ab649d37e Mon Sep 17 00:00:00 2001
From: Nathan Kidd <nkidd@opentext.com>
Date: Fri, 9 Jan 2015 09:57:23 -0500
Subject: Unvalidated lengths

v2: Add overflow check and remove unnecessary check (Julien Cristau)

This addresses:
CVE-2017-12184 in XINERAMA
CVE-2017-12185 in MIT-SCREEN-SAVER
CVE-2017-12186 in X-Resource
CVE-2017-12187 in RENDER

Reviewed-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Reviewed-by: Julien Cristau <jcristau@debian.org>
Signed-off-by: Nathan Kidd <nkidd@opentext.com>
Signed-off-by: Julien Cristau <jcristau@debian.org>

Index: xorg-server-1.18.4/Xext/panoramiX.c
===================================================================
--- xorg-server-1.18.4.orig/Xext/panoramiX.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/Xext/panoramiX.c	2017-10-13 08:41:44.943777390 -0400
@@ -988,10 +988,11 @@ ProcPanoramiXGetScreenSize(ClientPtr cli
     xPanoramiXGetScreenSizeReply rep;
     int rc;
 
+    REQUEST_SIZE_MATCH(xPanoramiXGetScreenSizeReq);
+
     if (stuff->screen >= PanoramiXNumScreens)
         return BadMatch;
 
-    REQUEST_SIZE_MATCH(xPanoramiXGetScreenSizeReq);
     rc = dixLookupWindow(&pWin, stuff->window, client, DixGetAttrAccess);
     if (rc != Success)
         return rc;
Index: xorg-server-1.18.4/Xext/saver.c
===================================================================
--- xorg-server-1.18.4.orig/Xext/saver.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/Xext/saver.c	2017-10-13 08:41:44.943777390 -0400
@@ -1185,6 +1185,8 @@ ProcScreenSaverUnsetAttributes(ClientPtr
         PanoramiXRes *draw;
         int rc, i;
 
+        REQUEST_SIZE_MATCH(xScreenSaverUnsetAttributesReq);
+
         rc = dixLookupResourceByClass((void **) &draw, stuff->drawable,
                                       XRC_DRAWABLE, client, DixWriteAccess);
         if (rc != Success)
Index: xorg-server-1.18.4/Xext/xres.c
===================================================================
--- xorg-server-1.18.4.orig/Xext/xres.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/Xext/xres.c	2017-10-13 08:41:44.943777390 -0400
@@ -1039,6 +1039,8 @@ ProcXResQueryResourceBytes (ClientPtr cl
     ConstructResourceBytesCtx    ctx;
 
     REQUEST_AT_LEAST_SIZE(xXResQueryResourceBytesReq);
+    if (stuff->numSpecs > UINT32_MAX / sizeof(ctx.specs[0]))
+        return BadLength;
     REQUEST_FIXED_SIZE(xXResQueryResourceBytesReq,
                        stuff->numSpecs * sizeof(ctx.specs[0]));
 
@@ -1144,8 +1146,8 @@ SProcXResQueryResourceBytes (ClientPtr c
     int c;
     xXResResourceIdSpec *specs = (void*) ((char*) stuff + sizeof(*stuff));
 
-    swapl(&stuff->numSpecs);
     REQUEST_AT_LEAST_SIZE(xXResQueryResourceBytesReq);
+    swapl(&stuff->numSpecs);
     REQUEST_FIXED_SIZE(xXResQueryResourceBytesReq,
                        stuff->numSpecs * sizeof(specs[0]));
 
Index: xorg-server-1.18.4/Xext/xvdisp.c
===================================================================
--- xorg-server-1.18.4.orig/Xext/xvdisp.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/Xext/xvdisp.c	2017-10-13 08:41:44.943777390 -0400
@@ -1496,12 +1496,14 @@ XineramaXvShmPutImage(ClientPtr client)
 {
     REQUEST(xvShmPutImageReq);
     PanoramiXRes *draw, *gc, *port;
-    Bool send_event = stuff->send_event;
+    Bool send_event;
     Bool isRoot;
     int result, i, x, y;
 
     REQUEST_SIZE_MATCH(xvShmPutImageReq);
 
+    send_event = stuff->send_event;
+
     result = dixLookupResourceByClass((void **) &draw, stuff->drawable,
                                       XRC_DRAWABLE, client, DixWriteAccess);
     if (result != Success)
Index: xorg-server-1.18.4/hw/dmx/dmxpict.c
===================================================================
--- xorg-server-1.18.4.orig/hw/dmx/dmxpict.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/hw/dmx/dmxpict.c	2017-10-13 08:41:44.947777432 -0400
@@ -716,6 +716,8 @@ dmxProcRenderSetPictureFilter(ClientPtr
         filter = (char *) (stuff + 1);
         params = (XFixed *) (filter + ((stuff->nbytes + 3) & ~3));
         nparams = ((XFixed *) stuff + client->req_len) - params;
+        if (nparams < 0)
+            return BadLength;
 
         XRenderSetPictureFilter(dmxScreen->beDisplay,
                                 pPictPriv->pict, filter, params, nparams);
Index: xorg-server-1.18.4/pseudoramiX/pseudoramiX.c
===================================================================
--- xorg-server-1.18.4.orig/pseudoramiX/pseudoramiX.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/pseudoramiX/pseudoramiX.c	2017-10-13 08:41:44.947777432 -0400
@@ -297,10 +297,11 @@ ProcPseudoramiXGetScreenSize(ClientPtr c
 
     TRACE;
 
+    REQUEST_SIZE_MATCH(xPanoramiXGetScreenSizeReq);
+
     if (stuff->screen >= pseudoramiXNumScreens)
       return BadMatch;
 
-    REQUEST_SIZE_MATCH(xPanoramiXGetScreenSizeReq);
     rc = dixLookupWindow(&pWin, stuff->window, client, DixGetAttrAccess);
     if (rc != Success)
         return rc;
Index: xorg-server-1.18.4/render/render.c
===================================================================
--- xorg-server-1.18.4.orig/render/render.c	2017-10-13 08:41:44.959777554 -0400
+++ xorg-server-1.18.4/render/render.c	2017-10-13 08:41:44.947777432 -0400
@@ -1770,6 +1770,9 @@ ProcRenderSetPictureFilter(ClientPtr cli
     name = (char *) (stuff + 1);
     params = (xFixed *) (name + pad_to_int32(stuff->nbytes));
     nparams = ((xFixed *) stuff + client->req_len) - params;
+    if (nparams < 0)
+	return BadLength;
+
     result = SetPictureFilter(pPicture, name, stuff->nbytes, params, nparams);
     return result;
 }
