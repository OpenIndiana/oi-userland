From be3004dc350a820a5b0320b34bd05673ba534058 Mon Sep 17 00:00:00 2001
From: law <law@138bc75d-0d04-0410-961f-82ee72b054a4>
Date: Thu, 31 Mar 2016 17:20:53 +0000
Subject: [PATCH] 	* cplus-dem.c (squangle_mop_up): Zero bsize/ksize
 after freeing 	btypevec/ktypevec. 	* testsuite/demangle-expected: Add
 coverage tests.

git-svn-id: svn+ssh://gcc.gnu.org/svn/gcc/trunk@234645 138bc75d-0d04-0410-961f-82ee72b054a4
---
 libiberty/ChangeLog                   |  7 +++++++
 libiberty/cplus-dem.c                 |  2 ++
 libiberty/testsuite/demangle-expected | 10 ++++++++++
 3 files changed, 19 insertions(+)

#diff --git a/libiberty/ChangeLog b/libiberty/ChangeLog
#index d11f4ce..b4054bd 100644
#--- a/libiberty/ChangeLog
#+++ b/libiberty/ChangeLog
#@@ -1,3 +1,10 @@
#+2016-03-31  Mikhail Maltsev  <maltsevm@gmail.com>
#+	    Marcel Bohme  boehme.marcel@gmail.com
#+
#+	* cplus-dem.c (squangle_mop_up): Zero bsize/ksize after freeing
#+	btypevec/ktypevec.
#+	* testsuite/demangle-expected: Add coverage tests.
#+
# 2016-01-27  Iain Buclaw  <ibuclaw@gdcproject.org>
# 
# 	* d-demangle.c (dlang_call_convention): Handle extern Objective-C
Index: gdb-7.11.1/libiberty/cplus-dem.c
===================================================================
--- gdb-7.11.1.orig/libiberty/cplus-dem.c	2017-06-08 07:52:55.737197785 -0400
+++ gdb-7.11.1/libiberty/cplus-dem.c	2017-06-08 07:52:55.721197580 -0400
@@ -1244,11 +1244,13 @@ squangle_mop_up (struct work_stuff *work
     {
       free ((char *) work -> btypevec);
       work->btypevec = NULL;
+      work->bsize = 0;
     }
   if (work -> ktypevec != NULL)
     {
       free ((char *) work -> ktypevec);
       work->ktypevec = NULL;
+      work->ksize = 0;
     }
 }
 
Index: gdb-7.11.1/libiberty/testsuite/demangle-expected
===================================================================
--- gdb-7.11.1.orig/libiberty/testsuite/demangle-expected	2017-06-08 07:52:55.737197785 -0400
+++ gdb-7.11.1/libiberty/testsuite/demangle-expected	2017-06-08 07:52:55.725197631 -0400
@@ -4421,3 +4421,13 @@ void baz<int>(A<sizeof (foo((int)(), (fl
 --format=gnu-v3
 _Z3fooI1FEN1XIXszdtcl1PclcvT__EEE5arrayEE4TypeEv
 X<sizeof ((P(((F)())())).array)>::Type foo<F>()
+#
+# Tests a use-after-free problem
+
+_Q.__0
+::Q.(void)
+#
+# Tests a use-after-free problem
+
+_Q10-__9cafebabe.
+cafebabe.::-(void)
