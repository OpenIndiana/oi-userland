From 4aacf8726658d9d10a027a6363adb197ac875046 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 20 Nov 2018 16:07:51 +0000
Subject: [PATCH 16/16] libgcc-unwind.map should be v2-style

---
 libgcc/config/t-slibgcc-sld | 27 +++++++++++++++++++++++----
 1 file changed, 23 insertions(+), 4 deletions(-)

diff --git a/libgcc/config/t-slibgcc-sld b/libgcc/config/t-slibgcc-sld
index 0b9539114e4..55fd6e1caa7 100644
--- a/libgcc/config/t-slibgcc-sld
+++ b/libgcc/config/t-slibgcc-sld
@@ -8,13 +8,32 @@ ifeq ($(enable_shared),yes)
 
 # Linker mapfile to enforce direct binding to libgcc_s unwinder
 # (PR target/59788).
+
+ifeq ($(with_gnu_ld),yes)
+
+libgcc-unwind.map: libgcc-std.ver
+	@(echo "{";                             \
+	for f in `grep _Unwind_ $< | sort`; do  \
+	  echo "        $$f = EXTERN DIRECT;";  \
+	done;                                   \
+	echo "};" ) > $@
+
+else
+
 libgcc-unwind.map: libgcc-std.ver
-	@(echo "{";				\
-	for f in `grep _Unwind_ $< | sort`; do	\
-	  echo "	$$f = EXTERN DIRECT;";	\
-	done;					\
+	@(echo "# Generated by libgcc/config/t-slibgcc-sld";	\
+	echo;							\
+	echo '$$mapfile_version 2'; 				\
+	echo;							\
+	echo "SYMBOL_SCOPE {";					\
+	echo "    global:";					\
+	for f in `grep _Unwind_ $< | sort`; do			\
+	  echo "	$$f { FLAGS = EXTERN DIRECT };";	\
+	done;							\
 	echo "};" ) > $@
 
+endif
+
 # Copy libgcc-unwind.map to the place where gcc will look for it at build-time.
 install-libgcc-unwind-map-forbuild: libgcc-unwind.map
 	dest=$(gcc_objdir)/tmp$$$$-$<; \
-- 
2.20.1

