Description: fix denial of service and possible code execution via
 overflow in _asn1_ltostr
Origin: backport, http://git.savannah.gnu.org/gitweb/?p=libtasn1.git;a=commit;h=e47b2a0651ffe1867c844968ade7f6127957bf13
Origin: backport, http://git.savannah.gnu.org/gitweb/?p=libtasn1.git;a=commitdiff;h=4d4f992826a4962790ecd0cce6fbba4a415ce149

Index: libtasn1-3-2.10/lib/coding.c
===================================================================
--- libtasn1-3-2.10.orig/lib/coding.c	2015-04-02 11:35:14.121673749 -0400
+++ libtasn1-3-2.10/lib/coding.c	2015-04-02 11:35:28.385789123 -0400
@@ -35,6 +35,10 @@
 
 #define MAX_TAG_LEN 16
 
+#ifndef MAX
+# define MAX(a,b) ((a) > (b) ? (a) : (b))
+#endif
+
 /******************************************************/
 /* Function : _asn1_error_description_value_not_found */
 /* Description: creates the ErrorDescription string   */
@@ -450,7 +454,7 @@
 {
   ASN1_TYPE p;
   int tag_len, is_tag_implicit;
-  unsigned char class, class_implicit = 0, temp[SIZEOF_UNSIGNED_INT * 3 + 1];
+  unsigned char class, class_implicit = 0, temp[MAX(SIZEOF_UNSIGNED_INT * 3 + 1, LTOSTR_MAX_SIZE)];
   unsigned long tag_implicit = 0;
   char tag_der[MAX_TAG_LEN];
 
@@ -870,7 +874,7 @@
 		 char *ErrorDescription)
 {
   ASN1_TYPE node, p, p2;
-  unsigned char temp[SIZEOF_UNSIGNED_LONG_INT * 3 + 1];
+  unsigned char temp[MAX(LTOSTR_MAX_SIZE, SIZEOF_UNSIGNED_LONG_INT * 3 + 1)];
   int counter, counter_old, len2, len3, tlen, move, max_len, max_len_old;
   asn1_retCode err;
   unsigned char *der = ider;
Index: libtasn1-3-2.10/lib/decoding.c
===================================================================
--- libtasn1-3-2.10.orig/lib/decoding.c	2015-04-02 11:35:14.121673749 -0400
+++ libtasn1-3-2.10/lib/decoding.c	2015-04-02 11:35:14.121673749 -0400
@@ -281,7 +281,7 @@
 {
   int len_len, len, k;
   int leading;
-  char temp[20];
+  char temp[LTOSTR_MAX_SIZE];
   unsigned long val, val1, prev_val;
 
   *ret_len = 0;
Index: libtasn1-3-2.10/lib/element.c
===================================================================
--- libtasn1-3-2.10.orig/lib/element.c	2015-04-02 11:35:14.121673749 -0400
+++ libtasn1-3-2.10/lib/element.c	2015-04-02 11:35:14.121673749 -0400
@@ -134,7 +134,7 @@
 _asn1_append_sequence_set (ASN1_TYPE node)
 {
   ASN1_TYPE p, p2;
-  char temp[10];
+  char temp[LTOSTR_MAX_SIZE];
   long n;
 
   if (!node || !(node->down))
Index: libtasn1-3-2.10/lib/parser_aux.c
===================================================================
--- libtasn1-3-2.10.orig/lib/parser_aux.c	2015-04-02 11:35:14.121673749 -0400
+++ libtasn1-3-2.10/lib/parser_aux.c	2015-04-02 11:35:14.121673749 -0400
@@ -580,10 +580,10 @@
 
 
 char *
-_asn1_ltostr (long v, char *str)
+_asn1_ltostr (long v, char str[LTOSTR_MAX_SIZE])
 {
   long d, r;
-  char temp[20];
+  char temp[LTOSTR_MAX_SIZE];
   int count, k, start;
 
   if (v < 0)
@@ -604,7 +604,7 @@
       count++;
       v = d;
     }
-  while (v);
+  while (v && ((start+count) < LTOSTR_MAX_SIZE-1));
 
   for (k = 0; k < count; k++)
     str[k + start] = temp[start + count - k - 1];
Index: libtasn1-3-2.10/lib/parser_aux.h
===================================================================
--- libtasn1-3-2.10.orig/lib/parser_aux.h	2015-04-02 11:35:14.121673749 -0400
+++ libtasn1-3-2.10/lib/parser_aux.h	2015-04-02 11:35:14.121673749 -0400
@@ -63,7 +63,9 @@
 
 void _asn1_delete_list_and_nodes (void);
 
-char *_asn1_ltostr (long v, char *str);
+/* Max 64-bit integer length is 20 chars + 1 for sign + 1 for null termination */
+#define LTOSTR_MAX_SIZE 22
+char *_asn1_ltostr (long v, char str[LTOSTR_MAX_SIZE]);
 
 ASN1_TYPE _asn1_find_up (ASN1_TYPE node);
 
