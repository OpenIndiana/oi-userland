#
# This file and its contents are supplied under the terms of the
# Common Development and Distribution License ("CDDL"). You may
# only use this file in accordance with the terms of the CDDL.
#
# A full copy of the text of the CDDL should have accompanied this
# source. A copy of the CDDL is also available via the Internet at
# http://www.illumos.org/license/CDDL.
#

#
# Copyright 2020 Alexander Pyhalov
#

BUILD_BITS=32

include ../../../make-rules/shared-macros.mk

COMPONENT_NAME=	libreoffice
COMPONENT_VERSION= 6.4.3
COMPONENT_RC_VERSION= 2
COMPONENT_REVISION= 1
COMPONENT_FULL_VERSION=$(COMPONENT_VERSION).$(COMPONENT_RC_VERSION)
COMPONENT_SUMMARY= LibreOffice is a powerful office suite
COMPONENT_PROJECT_URL= https://www.libreoffice.org/
COMPONENT_FMRI= desktop/office/libreoffice
COMPONENT_CLASSIFICATION= Applications/Office
COMPONENT_SRC=		$(COMPONENT_NAME)-$(COMPONENT_FULL_VERSION)
COMPONENT_ARCHIVE=	$(COMPONENT_SRC).tar.xz
COMPONENT_ARCHIVE_URL= https://download.documentfoundation.org/libreoffice/src/$(COMPONENT_VERSION)/$(COMPONENT_ARCHIVE)
COMPONENT_SIG_URL= $(COMPONENT_ARCHIVE_URL).asc
COMPONENT_ARCHIVE_HASH= sha256:bc14547c188efa15f4cb36cfb3da7cacb3037a7448d1bba8a58ed6a320ccabb2
COMPONENT_LICENSE= MPL2.0
COMPONENT_LICENSE_FILE= COPYING.MPL

COMPONENT_ARCHIVE_1 = 0168229624cfac409e766913506961a8-ucpp-1.3.2.tar.gz
COMPONENT_ARCHIVE_HASH_1 = sha256:983941d31ee8d366085cadf28db75eb1f5cb03ba1e5853b98f12f7f51c63b776
COMPONENT_ARCHIVE_URL_1 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_1)

COMPONENT_ARCHIVE_2 = 1f5def51ca0026cd192958ef07228b52-rasqal-0.9.33.tar.gz
OMPONENT_ARCHIVE_HASH_2 = sha256:6924c9ac6570bd241a9669f83b467c728a322470bf34f4b2da4f69492ccfd97c
COMPONENT_ARCHIVE_URL_2 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_2)

COMPONENT_ARCHIVE_3 = 26b3e95ddf3d9c077c480ea45874b3b8-lp_solve_5.5.tar.gz
COMPONENT_ARCHIVE_HASH_3 = sha256:171816288f14215c69e730f7a4f1c325739873e21f946ff83884b350574e6695
COMPONENT_ARCHIVE_URL_3 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_3)

COMPONENT_ARCHIVE_4 = 48d647fbd8ef8889e5a7f422c1bfda94-clucene-core-2.3.3.4.tar.gz
COMPONENT_ARCHIVE_HASH_4 = sha256:ddfdc433dd8ad31b5c5819cc4404a8d2127472a3b720d3e744e8c51d79732eab
COMPONENT_ARCHIVE_URL_4 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_4)

COMPONENT_ARCHIVE_5 = 5ade6ae2a99bc1e9e57031ca88d36dad-hyphen-2.8.8.tar.gz
COMPONENT_ARCHIVE_HASH_5 = sha256:304636d4eccd81a14b6914d07b84c79ebb815288c76fe027b9ebff6ff24d5705
COMPONENT_ARCHIVE_URL_5 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_5)

COMPONENT_ARCHIVE_6 = 884ed41809687c3e168fc7c19b16585149ff058eca79acbf3ee784f6630704cc-opens___.ttf
COMPONENT_ARCHIVE_HASH_6 = sha256:884ed41809687c3e168fc7c19b16585149ff058eca79acbf3ee784f6630704cc
COMPONENT_ARCHIVE_URL_6 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_6)

COMPONENT_ARCHIVE_7 = a233181e03d3c307668b4c722d881661-mariadb_client-2.0.0-src.tar.gz
COMPONENT_ARCHIVE_HASH_7 = sha256:fd2f751dea049c1907735eb236aeace1d811d6a8218118b00bbaa9b84dc5cd60
COMPONENT_ARCHIVE_URL_7 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_7)

COMPONENT_ARCHIVE_8 = a39f6c07ddb20d7dd2ff1f95fa21e2cd-raptor2-2.0.15.tar.gz
COMPONENT_ARCHIVE_HASH_8 = sha256:ada7f0ba54787b33485d090d3d2680533520cd4426d2f7fb4782dd4a6a1480ed
COMPONENT_ARCHIVE_URL_8 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_8)

COMPONENT_ARCHIVE_9 = a8c2c5b8f09e7ede322d5c602ff6a4b6-mythes-1.2.4.tar.gz
COMPONENT_ARCHIVE_HASH_9 = sha256:1e81f395d8c851c3e4e75b568e20fa2fa549354e75ab397f9de4b0e0790a305f
COMPONENT_ARCHIVE_URL_9 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_9)

COMPONENT_ARCHIVE_10 = bae83fa5dc7f081768daace6e199adc3-glm-0.9.4.6-libreoffice.zip
COMPONENT_ARCHIVE_HASH_10 = sha256:d0312c360efe04dd048b3311fe375ff36f1993b4c2e3cb58c81062990532904a
COMPONENT_ARCHIVE_URL_10 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_10)

COMPONENT_ARCHIVE_11 = CoinMP-1.7.6.tgz
COMPONENT_ARCHIVE_HASH_11 = sha256:86c798780b9e1f5921fe4efe651a93cb420623b45aa1fdff57af8c37f116113f
COMPONENT_ARCHIVE_URL_11 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_11)

COMPONENT_ARCHIVE_12 = e5be03eda13ef68aabab6e42aa67715e-redland-1.0.17.tar.gz
COMPONENT_ARCHIVE_HASH_12 = sha256:de1847f7b59021c16bdc72abb4d8e2d9187cd6124d69156f3326dd34ee043681
COMPONENT_ARCHIVE_URL_12 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_12)

COMPONENT_ARCHIVE_13 = language-subtag-registry-2019-09-16.tar.bz2
COMPONENT_ARCHIVE_HASH_13 = sha256:07b66bc0f2786fde55f6bbcbcb4a455a846eb8e2351c8ce3d0a219a73693736a
COMPONENT_ARCHIVE_URL_13 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_13)

COMPONENT_ARCHIVE_14 = libexttextcat-3.4.5.tar.xz
COMPONENT_ARCHIVE_HASH_14 = sha256:13fdbc9d4c489a4d0519e51933a1aa21fe3fb9eb7da191b87f7a63e82797dac8
COMPONENT_ARCHIVE_URL_14 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_14)

COMPONENT_ARCHIVE_15 = libnumbertext-1.0.5.tar.xz
COMPONENT_ARCHIVE_HASH_15 = sha256:e1c9086b4cecb6b25f180316f30740dfabe6a4dbaf70dddc34276fc839e4f4f7
COMPONENT_ARCHIVE_URL_15 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_15)

COMPONENT_ARCHIVE_16 = liborcus-0.15.3.tar.gz
COMPONENT_ARCHIVE_HASH_16 = sha256:0dd26f3f2e611c51df9ee02d6dbf08887989eaa417b73f6877cd0d94df795fc2
COMPONENT_ARCHIVE_URL_16 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_16)

COMPONENT_ARCHIVE_17 = QR-Code-generator-1.4.0.tar.gz
COMPONENT_ARCHIVE_HASH_17 = sha256:fcdf9fd69fde07ae4dca2351d84271a9de8093002f733b77c70f52f1630f6e4a
COMPONENT_ARCHIVE_URL_17 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_17)

COMPONENT_ARCHIVE_18 = xmlsec1-1.2.28.tar.gz
COMPONENT_ARCHIVE_HASH_18 = sha256:13eec4811ea30e3f0e16a734d1dbf7f9d246a71d540b48d143a07b489f6222d4
COMPONENT_ARCHIVE_URL_18 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_18)

COMPONENT_ARCHIVE_19 = libreoffice-translations-$(COMPONENT_FULL_VERSION).tar.xz
COMPONENT_ARCHIVE_HASH_19 = sha256:03260badad37d1d96c9bcac79ee48ab2ab00000aba78c3a4a4accd51c987e91b
COMPONENT_ARCHIVE_URL_19 = https://download.documentfoundation.org/libreoffice/src/$(COMPONENT_VERSION)/$(COMPONENT_ARCHIVE_19)

COMPONENT_ARCHIVE_20 = libreoffice-dictionaries-$(COMPONENT_FULL_VERSION).tar.xz
COMPONENT_ARCHIVE_HASH_20 = sha256:75deaae62faaa9c06afe04b5e1293e65c5e6ed5d91895a1432a817478ab35941
COMPONENT_ARCHIVE_URL_20 = https://download.documentfoundation.org/libreoffice/src/$(COMPONENT_VERSION)/$(COMPONENT_ARCHIVE_20)

COMPONENT_ARCHIVE_21 = boost_1_69_0.tar.bz2
COMPONENT_ARCHIVE_HASH_21 = sha256:8f32d4617390d1c2d16f26a27ab60d97807b35440d45891fa340fc2648b04406
COMPONENT_ARCHIVE_URL_21 = https://dev-www.libreoffice.org/src/$(COMPONENT_ARCHIVE_21)

NUM_EXTRA_ARCHIVES = $(shell seq 1 21)

include $(WS_MAKE_RULES)/common.mk

PATH=$(GCC_ROOT)/bin:$(PATH.gnu)

COMPONENT_BUILD_ENV=   CONFIG_SHELL="$(CONFIG_SHELL)"
COMPONENT_BUILD_ENV+=  SHELL="$(CONFIG_SHELL)"
COMPONENT_BUILD_ENV+=  CC="$(CC)"
COMPONENT_BUILD_ENV+=  CXX="$(CXX)"

CONFIGURE_ENV = $(COMPONENT_BUILD_ENV)
CONFIGURE_ENV += PYTHON=/usr/bin/python3.5

COMPONENT_PREP_ACTION= ( mkdir -p $(@D)/external/tarballs && \
	for i in $(ARCHIVES) ; do \
		rm -f $(@D)/external/tarballs/$$i && \
		ln -s $(USERLAND_ARCHIVES)/$$i $(@D)/external/tarballs/$$i ; \
	done && \
	cd $(@D) && autoconf )


# LDFLAGS seem to be not always passed to lower levels
CFLAGS += $(JPEG_CPPFLAGS) $(JPEG_LDFLAGS)
CFLAGS += -fstack-protector -lssp_nonshared

CXXFLAGS = $(CFLAGS)

CONFIGURE_OPTIONS += --with-myspell-dicts
CONFIGURE_OPTIONS += --with-help=common
CONFIGURE_OPTIONS += --enable-release-build
CONFIGURE_OPTIONS += --enable-gstreamer-1-0
CONFIGURE_OPTIONS += --disable-odk
CONFIGURE_OPTIONS += --with-system-cairo
CONFIGURE_OPTIONS += --with-system-expat
CONFIGURE_OPTIONS += --with-system-libxml
CONFIGURE_OPTIONS += --with-system-icu
CONFIGURE_OPTIONS += --with-system-poppler
CONFIGURE_OPTIONS += --with-system-curl
# Our boost is too old
#CONFIGURE_OPTIONS += --with-system-boost
CONFIGURE_OPTIONS += --with-system-nss
CONFIGURE_OPTIONS += --with-system-apr
CONFIGURE_OPTIONS += --with-system-neon
CONFIGURE_OPTIONS += --with-system-openssl
CONFIGURE_OPTIONS += --with-system-libpng
CONFIGURE_OPTIONS += --with-system-jpeg
CONFIGURE_OPTIONS += --with-system-harfbuzz
CONFIGURE_OPTIONS += --with-system-graphite
CONFIGURE_OPTIONS += --with-system-cppunit
CONFIGURE_OPTIONS += --with-system-lcms2
CONFIGURE_OPTIONS += --with-system-dicts
CONFIGURE_OPTIONS += --with-system-epoxy
CONFIGURE_OPTIONS += --with-system-hunspell
CONFIGURE_OPTIONS += --with-system-mdds
CONFIGURE_OPTIONS += --with-system-libabw
CONFIGURE_OPTIONS += --with-system-libcdr
CONFIGURE_OPTIONS += --with-system-libcmis
CONFIGURE_OPTIONS += --with-system-libetonyek
CONFIGURE_OPTIONS += --with-system-libebook
CONFIGURE_OPTIONS += --with-system-libepubgen
CONFIGURE_OPTIONS += --with-system-libfreehand
CONFIGURE_OPTIONS += --with-system-liblangtag
CONFIGURE_OPTIONS += --with-system-libmspub
CONFIGURE_OPTIONS += --with-system-libmwaw
CONFIGURE_OPTIONS += --with-system-libodfgen
CONFIGURE_OPTIONS += --with-system-libpagemaker
CONFIGURE_OPTIONS += --with-system-libqxp
CONFIGURE_OPTIONS += --with-system-librevenge
CONFIGURE_OPTIONS += --with-system-libstaroffice
CONFIGURE_OPTIONS += --with-system-libvisio
CONFIGURE_OPTIONS += --with-system-libwpd
CONFIGURE_OPTIONS += --with-system-libwpg
CONFIGURE_OPTIONS += --with-system-libwps
CONFIGURE_OPTIONS += --with-system-libzmf
CONFIGURE_OPTIONS += --enable-gio
CONFIGURE_OPTIONS += --with-lang=ALL
CONFIGURE_OPTIONS += --disable-firebird-sdbc
CONFIGURE_OPTIONS += --disable-postgresql-sdbc
CONFIGURE_OPTIONS += --disable-pdfium
CONFIGURE_OPTIONS += --with-java=no
CONFIGURE_OPTIONS += --without-help
CONFIGURE_OPTIONS += --without-fonts
CONFIGURE_OPTIONS += --enable-cups
CONFIGURE_OPTIONS += --with-epm=internal
CONFIGURE_OPTIONS += --with-vendor="OpenIndiana"
CONFIGURE_OPTIONS += --with-tls="openssl"
CONFIGURE_OPTIONS += --with-system-openldap
CONFIGURE_OPTIONS += --enable-python=no
CONFIGURE_OPTIONS += --disable-cve-tests

COMPONENT_BUILD_ENV += GMAKE_OPTIONS='VERBOSE=1 gb_SUPPRESS_TESTS=x'

COMPONENT_INSTALL_TARGETS = distro-pack-install

LIBREOFFICE_PROGRAM_DIR = /usr/lib/libreoffice/program

NSS_LIB_DIR=/usr/lib/mps

COMPONENT_POST_INSTALL_ACTION  = \
    for file in $(PROTO_DIR)$(LIBREOFFICE_PROGRAM_DIR)/*.so*; do \
        /usr/bin/elfedit -e 'dyn:value -s  RUNPATH "$(GCC_LIBDIR):$(LIBREOFFICE_PROGRAM_DIR):$(NSS_LIB_DIR):$(JPEG_LIBDIR)"' $$file ; \
        /usr/bin/elfedit -e 'dyn:value -s  RPATH "$(GCC_LIBDIR):$(LIBREOFFICE_PROGRAM_DIR):$(NSS_LIB_DIR):$(JPEG_LIBDIR)"' $$file ; \
    done ;

# Build dependencies
REQUIRED_PACKAGES += developer/assembler/nasm
REQUIRED_PACKAGES += developer/cppunit
REQUIRED_PACKAGES += developer/gperf
REQUIRED_PACKAGES += developer/icu
REQUIRED_PACKAGES += file/gnu-coreutils
REQUIRED_PACKAGES += library/c++/mdds

# Auto-generated dependencies
REQUIRED_PACKAGES += $(GCC_RUNTIME_PKG)
REQUIRED_PACKAGES += $(GXX_RUNTIME_PKG)
REQUIRED_PACKAGES += compress/xz
REQUIRED_PACKAGES += gnome/config/dconf
REQUIRED_PACKAGES += image/library/libjpeg8-turbo
REQUIRED_PACKAGES += image/library/libpng16
REQUIRED_PACKAGES += library/audio/gstreamer1
REQUIRED_PACKAGES += library/audio/gstreamer1/plugin/base
REQUIRED_PACKAGES += library/c++/graphite2
REQUIRED_PACKAGES += library/c++/harfbuzz
REQUIRED_PACKAGES += library/c++/libabw
REQUIRED_PACKAGES += library/c++/libcdr
REQUIRED_PACKAGES += library/c++/libcmis
REQUIRED_PACKAGES += library/c++/libe-book
REQUIRED_PACKAGES += library/c++/libepubgen
REQUIRED_PACKAGES += library/c++/libetonyek
REQUIRED_PACKAGES += library/c++/libfreehand
REQUIRED_PACKAGES += library/c++/libmspub
REQUIRED_PACKAGES += library/c++/libmwaw
REQUIRED_PACKAGES += library/c++/libodfgen
REQUIRED_PACKAGES += library/c++/libpagemaker
REQUIRED_PACKAGES += library/c++/libqxp
REQUIRED_PACKAGES += library/c++/librevenge
REQUIRED_PACKAGES += library/c++/libstaroffice
REQUIRED_PACKAGES += library/c++/libvisio
REQUIRED_PACKAGES += library/c++/libwpd
REQUIRED_PACKAGES += library/c++/libwpg
REQUIRED_PACKAGES += library/c++/libwps
REQUIRED_PACKAGES += library/c++/libzmf
REQUIRED_PACKAGES += library/desktop/atk
REQUIRED_PACKAGES += library/desktop/cairo
REQUIRED_PACKAGES += library/desktop/gdk-pixbuf
REQUIRED_PACKAGES += library/desktop/gtk3
REQUIRED_PACKAGES += library/desktop/pango
REQUIRED_PACKAGES += library/expat
REQUIRED_PACKAGES += library/glib2
REQUIRED_PACKAGES += library/icu
REQUIRED_PACKAGES += library/lcms2
REQUIRED_PACKAGES += library/liblangtag
REQUIRED_PACKAGES += library/libpoppler
REQUIRED_PACKAGES += library/libxml2
REQUIRED_PACKAGES += library/libxslt
REQUIRED_PACKAGES += library/neon
REQUIRED_PACKAGES += library/nspr
REQUIRED_PACKAGES += library/openldap
REQUIRED_PACKAGES += library/print/cups-libs
REQUIRED_PACKAGES += library/security/openssl
REQUIRED_PACKAGES += library/zlib
REQUIRED_PACKAGES += SUNWcs
REQUIRED_PACKAGES += system/library
REQUIRED_PACKAGES += system/library/fontconfig
REQUIRED_PACKAGES += system/library/freetype-2
REQUIRED_PACKAGES += system/library/libdbus
REQUIRED_PACKAGES += system/library/math
REQUIRED_PACKAGES += system/library/mozilla-nss
REQUIRED_PACKAGES += text/hunspell
REQUIRED_PACKAGES += web/curl
REQUIRED_PACKAGES += x11/library/libepoxy
REQUIRED_PACKAGES += x11/library/libice
REQUIRED_PACKAGES += x11/library/libsm
REQUIRED_PACKAGES += x11/library/libx11
REQUIRED_PACKAGES += x11/library/libxext
REQUIRED_PACKAGES += x11/library/libxinerama
REQUIRED_PACKAGES += x11/library/libxrandr
REQUIRED_PACKAGES += x11/library/libxrender
