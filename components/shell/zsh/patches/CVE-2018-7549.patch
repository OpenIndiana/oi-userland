From c2cc8b0fbefc9868fa83537f5b6d90fc1ec438dd Mon Sep 17 00:00:00 2001
From: Stephane Chazelas <stephane.chazelas@gmail.com>
Date: Fri, 22 Dec 2017 22:17:09 +0000
Subject: [PATCH] Avoid crash copying empty hash table.

Visible with typeset -p.
---
 ChangeLog    |  2 ++
 Src/params.c | 11 +++++++----
 2 files changed, 9 insertions(+), 4 deletions(-)

#diff --git a/ChangeLog b/ChangeLog
#index f74c26b..e3628cf 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,5 +1,7 @@
# 2018-01-04  Peter Stephenson  <p.stephenson@samsung.com>
# 
#+	* Stephane: 42159: Src/params.c: avoid crash copying empty hash table.
#+
# 	* Sebastian: 42188: Src/Modules/system.c: It is necessary to
# 	close the lock descriptor in some failure cases.
# 
Index: zsh-5.2/Src/params.c
===================================================================
--- zsh-5.2.orig/Src/params.c
+++ zsh-5.2/Src/params.c
@@ -503,10 +503,13 @@ scancopyparams(HashNode hn, UNUSED(int f
 HashTable
 copyparamtable(HashTable ht, char *name)
 {
-    HashTable nht = newparamtable(ht->hsize, name);
-    outtable = nht;
-    scanhashtable(ht, 0, 0, 0, scancopyparams, 0);
-    outtable = NULL;
+    HashTable nht = 0;
+    if (ht) {
+	nht = newparamtable(ht->hsize, name);
+	outtable = nht;
+	scanhashtable(ht, 0, 0, 0, scancopyparams, 0);
+	outtable = NULL;
+    }
     return nht;
 }
 
