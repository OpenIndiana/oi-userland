Description: fix signature forgery issue
 Thanks to RedHat for the backport to 2.8.5.
Origin: vendor, https://bugzilla.redhat.com/attachment.cgi?id=997548
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=1194371

Index: gnutls26-2.8.5/lib/gnutls_algorithms.c
===================================================================
--- gnutls26-2.8.5.orig/lib/gnutls_algorithms.c	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/gnutls_algorithms.c	2015-03-20 09:50:01.731323718 -0400
@@ -1849,6 +1849,14 @@
   return ret;
 }
 
+int
+_gnutls_sign_get_hash (gnutls_sign_algorithm_t algorithm)
+{
+  GNUTLS_SIGN_LOOP (if (p->id == algorithm) return p->mac);
+
+  return GNUTLS_MAC_UNKNOWN;
+}
+
 gnutls_sign_algorithm_t
 _gnutls_x509_oid2sign_algorithm (const char *oid)
 {
Index: gnutls26-2.8.5/lib/gnutls_algorithms.h
===================================================================
--- gnutls26-2.8.5.orig/lib/gnutls_algorithms.h	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/gnutls_algorithms.h	2015-03-20 09:50:01.731323718 -0400
@@ -93,6 +93,7 @@
 enum encipher_type _gnutls_kx_encipher_type (gnutls_kx_algorithm_t algorithm);
 
 /* Functions for sign algorithms. */
+int _gnutls_sign_get_hash (gnutls_sign_algorithm_t algorithm);
 gnutls_sign_algorithm_t _gnutls_x509_oid2sign_algorithm (const char *oid);
 gnutls_sign_algorithm_t _gnutls_x509_pk_to_sign (gnutls_pk_algorithm_t pk,
 						 gnutls_mac_algorithm_t mac);
Index: gnutls26-2.8.5/lib/x509/privkey.c
===================================================================
--- gnutls26-2.8.5.orig/lib/x509/privkey.c	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/x509/privkey.c	2015-03-20 09:50:01.731323718 -0400
@@ -1589,7 +1589,8 @@
       return GNUTLS_E_INVALID_REQUEST;
     }
 
-  result = _gnutls_x509_privkey_verify_signature (data, signature, key);
+  result = _gnutls_x509_privkey_verify_signature (GNUTLS_MAC_UNKNOWN, data, signature, key);
+
   if (result < 0)
     {
       gnutls_assert ();
Index: gnutls26-2.8.5/lib/x509/verify.c
===================================================================
--- gnutls26-2.8.5.orig/lib/x509/verify.c	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/x509/verify.c	2015-03-20 09:50:26.155538797 -0400
@@ -271,6 +271,7 @@
   gnutls_datum_t cert_signature = { NULL, 0 };
   gnutls_x509_crt_t issuer = NULL;
   int ret, issuer_version, result = 0;
+  int sigalg, hashalg;
 
   if (output)
     *output = 0;
@@ -365,8 +366,19 @@
       goto cleanup;
     }
 
+  sigalg = gnutls_x509_crt_get_signature_algorithm (cert);
+  hashalg = _gnutls_sign_get_hash(sigalg);
+
+  if (hashalg == GNUTLS_MAC_UNKNOWN)
+    {
+      gnutls_assert();
+      result = 0;
+      goto cleanup;
+    }
+
   result =
-    _gnutls_x509_verify_signature (&cert_signed_data, NULL, &cert_signature,
+    _gnutls_x509_verify_signature (hashalg,
+                                   &cert_signed_data, NULL, &cert_signature,
 				   issuer);
   if (result < 0)
     {
@@ -389,10 +401,6 @@
    */
   if (is_issuer (cert, cert) == 0)
     {
-      int sigalg;
-
-      sigalg = gnutls_x509_crt_get_signature_algorithm (cert);
-
       if (((sigalg == GNUTLS_SIGN_RSA_MD2) &&
 	   !(flags & GNUTLS_VERIFY_ALLOW_SIGN_RSA_MD2)) ||
 	  ((sigalg == GNUTLS_SIGN_RSA_MD5) &&
@@ -663,12 +671,12 @@
  * params[1] is public key
  */
 static int
-_pkcs1_rsa_verify_sig (const gnutls_datum_t * text,
+_pkcs1_rsa_verify_sig (gnutls_mac_algorithm_t hash, const gnutls_datum_t * text,
 		       const gnutls_datum_t * prehash,
 		       const gnutls_datum_t * signature, bigint_t * params,
 		       int params_len)
 {
-  gnutls_mac_algorithm_t hash = GNUTLS_MAC_UNKNOWN;
+  gnutls_mac_algorithm_t phash = GNUTLS_MAC_UNKNOWN;
   int ret;
   opaque digest[MAX_HASH_SIZE], md[MAX_HASH_SIZE], *cmp;
   int digest_size;
@@ -688,7 +696,7 @@
 
   digest_size = sizeof (digest);
   if ((ret =
-       decode_ber_digest_info (&decrypted, &hash, digest, &digest_size)) != 0)
+       decode_ber_digest_info (&decrypted, &phash, digest, &digest_size)) != 0)
     {
       gnutls_assert ();
       _gnutls_free_datum (&decrypted);
@@ -697,6 +705,15 @@
 
   _gnutls_free_datum (&decrypted);
 
+  if (hash != GNUTLS_MAC_UNKNOWN && hash != phash)
+    {
+      gnutls_assert();
+      return GNUTLS_E_PK_SIG_VERIFY_FAILED;
+    }
+  else
+    hash = phash;
+  
+
   if (digest_size != _gnutls_hash_get_algo_len (hash))
     {
       gnutls_assert ();
@@ -779,7 +796,7 @@
  * or 1 otherwise.
  */
 static int
-verify_sig (const gnutls_datum_t * tbs,
+verify_sig (int hashalg, const gnutls_datum_t * tbs,
 	    const gnutls_datum_t * hash,
 	    const gnutls_datum_t * signature,
 	    gnutls_pk_algorithm_t pk, bigint_t * issuer_params,
@@ -791,7 +808,7 @@
     case GNUTLS_PK_RSA:
 
       if (_pkcs1_rsa_verify_sig
-	  (tbs, hash, signature, issuer_params, issuer_params_size) != 0)
+	  (hashalg, tbs, hash, signature, issuer_params, issuer_params_size) != 0)
 	{
 	  gnutls_assert ();
 	  return 0;
@@ -891,7 +908,7 @@
  * 'signature' is the signature!
  */
 int
-_gnutls_x509_verify_signature (const gnutls_datum_t * tbs,
+_gnutls_x509_verify_signature (int hashalg, const gnutls_datum_t * tbs,
 			       const gnutls_datum_t * hash,
 			       const gnutls_datum_t * signature,
 			       gnutls_x509_crt_t issuer)
@@ -911,7 +928,7 @@
     }
 
   ret =
-    verify_sig (tbs, hash, signature,
+    verify_sig (hashalg, tbs, hash, signature,
 		gnutls_x509_crt_get_pk_algorithm (issuer, NULL),
 		issuer_params, issuer_params_size);
   if (ret < 0)
@@ -936,13 +953,13 @@
  * 'signature' is the signature!
  */
 int
-_gnutls_x509_privkey_verify_signature (const gnutls_datum_t * tbs,
+_gnutls_x509_privkey_verify_signature (int hashalg, const gnutls_datum_t * tbs,
 				       const gnutls_datum_t * signature,
 				       gnutls_x509_privkey_t issuer)
 {
   int ret;
 
-  ret = verify_sig (tbs, NULL, signature, issuer->pk_algorithm,
+  ret = verify_sig (hashalg, tbs, NULL, signature, issuer->pk_algorithm,
 		    issuer->params, issuer->params_size);
   if (ret < 0)
     {
@@ -1170,7 +1187,7 @@
   gnutls_datum_t crl_signed_data = { NULL, 0 };
   gnutls_datum_t crl_signature = { NULL, 0 };
   gnutls_x509_crt_t issuer;
-  int ret, result;
+  int ret, result, sigalg, hashalg;
 
   if (output)
     *output = 0;
@@ -1222,8 +1239,18 @@
       goto cleanup;
     }
 
+
+  sigalg = gnutls_x509_crl_get_signature_algorithm (crl);
+  hashalg = _gnutls_sign_get_hash(sigalg);
+  if (hashalg == GNUTLS_MAC_UNKNOWN)
+    {
+      gnutls_assert();
+      result = 0;
+      goto cleanup;
+    }
+
   ret =
-    _gnutls_x509_verify_signature (&crl_signed_data, NULL, &crl_signature, issuer);
+    _gnutls_x509_verify_signature (hashalg, &crl_signed_data, NULL, &crl_signature, issuer);
   if (ret < 0)
     {
       gnutls_assert ();
@@ -1238,10 +1265,6 @@
     }
 
   {
-    int sigalg;
-
-    sigalg = gnutls_x509_crl_get_signature_algorithm (crl);
-
     if (((sigalg == GNUTLS_SIGN_RSA_MD2) &&
 	 !(flags & GNUTLS_VERIFY_ALLOW_SIGN_RSA_MD2)) ||
 	((sigalg == GNUTLS_SIGN_RSA_MD5) &&
Index: gnutls26-2.8.5/lib/x509/x509.c
===================================================================
--- gnutls26-2.8.5.orig/lib/x509/x509.c	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/x509/x509.c	2015-03-20 09:50:01.731323718 -0400
@@ -2426,7 +2426,7 @@
       return GNUTLS_E_INVALID_REQUEST;
     }
 
-  result = _gnutls_x509_verify_signature (data, NULL, signature, crt);
+  result = _gnutls_x509_verify_signature (GNUTLS_MAC_UNKNOWN, data, NULL, signature, crt);
   if (result < 0)
     {
       gnutls_assert ();
@@ -2462,7 +2462,7 @@
       return GNUTLS_E_INVALID_REQUEST;
     }
 
-  result = _gnutls_x509_verify_signature (NULL, hash, signature, crt);
+  result = _gnutls_x509_verify_signature (GNUTLS_MAC_UNKNOWN, NULL, hash, signature, crt);
   if (result < 0)
     {
       gnutls_assert ();
Index: gnutls26-2.8.5/lib/x509/x509_int.h
===================================================================
--- gnutls26-2.8.5.orig/lib/x509/x509_int.h	2015-03-20 09:50:01.731323718 -0400
+++ gnutls26-2.8.5/lib/x509/x509_int.h	2015-03-20 09:50:01.731323718 -0400
@@ -187,11 +187,11 @@
 int _gnutls_x509_verify_algorithm(gnutls_mac_algorithm_t *hash,
 				  const gnutls_datum_t * signature,
 				  const gnutls_x509_crt_t crt);
-int _gnutls_x509_verify_signature (const gnutls_datum_t * tbs,
+int _gnutls_x509_verify_signature (int sigalg, const gnutls_datum_t * tbs,
 				   const gnutls_datum_t * hash,
 				   const gnutls_datum_t * signature,
 				   gnutls_x509_crt_t issuer);
-int _gnutls_x509_privkey_verify_signature (const gnutls_datum_t * tbs,
+int _gnutls_x509_privkey_verify_signature (int hash, const gnutls_datum_t * tbs,
 					   const gnutls_datum_t * signature,
 					   gnutls_x509_privkey_t issuer);
 
