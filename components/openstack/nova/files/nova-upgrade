#!/usr/bin/python2.7

# Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.

import glob
import os
from subprocess import check_call, Popen, PIPE
import sys
import traceback

import iniparse
import smf_include
import sqlalchemy

from openstack_common import alter_mysql_tables, create_backups, modify_conf, \
    move_conf

NOVA_CONF_MAPPINGS = {
    # Deprecated group/name for Kilo
    ('DEFAULT', 'network_device_mtu'): (None, None),
    ('DEFAULT', 'log-format'): (None, None),
    ('DEFAULT', 'use-syslog'): (None, None),
    ('cinder', 'http_timeout'): ('cinder', 'timeout'),
    ('ironic', 'client_log_level'): (None, None),
    ('DEFAULT', 'amqp_durable_queues'):
        ('oslo_messaging_qpid', 'amqp_durable_queues'),
    ('DEFAULT', 'amqp_auto_delete'):
        ('oslo_messaging_qpid', 'amqp_auto_delete'),
    ('DEFAULT', 'rpc_conn_pool_size'):
        ('oslo_messaging_qpid', 'rpc_conn_pool_size'),
    ('DEFAULT', 'qpid_hostname'):
        ('oslo_messaging_qpid', 'qpid_hostname'),
    ('DEFAULT', 'qpid_port'):
        ('oslo_messaging_qpid', 'qpid_port'),
    ('DEFAULT', 'qpid_hosts'):
        ('oslo_messaging_qpid', 'qpid_hosts'),
    ('DEFAULT', 'qpid_username'):
        ('oslo_messaging_qpid', 'qpid_username'),
    ('DEFAULT', 'qpid_password'):
        ('oslo_messaging_qpid', 'qpid_password'),
    ('DEFAULT', 'qpid_sasl_mechanisms'):
        ('oslo_messaging_qpid', 'qpid_sasl_mechanisms'),
    ('DEFAULT', 'qpid_heartbeat'):
        ('oslo_messaging_qpid', 'qpid_heartbeat'),
    ('DEFAULT', 'qpid_protocol'):
        ('oslo_messaging_qpid', 'qpid_protocol'),
    ('DEFAULT', 'qpid_tcp_nodelay'):
        ('oslo_messaging_qpid', 'qpid_tcp_nodelay'),
    ('DEFAULT', 'qpid_receiver_capacity'):
        ('oslo_messaging_qpid', 'qpid_receiver_capacity'),
    ('DEFAULT', 'qpid_topology_version'):
        ('oslo_messaging_qpid', 'qpid_topology_version'),
    ('DEFAULT', 'kombu_ssl_version'):
        ('oslo_messaging_rabbit', 'kombu_ssl_version'),
    ('DEFAULT', 'kombu_ssl_keyfile'):
        ('oslo_messaging_rabbit', 'kombu_ssl_keyfile'),
    ('DEFAULT', 'kombu_ssl_certfile'):
        ('oslo_messaging_rabbit', 'kombu_ssl_certfile'),
    ('DEFAULT', 'kombu_ssl_ca_certs'):
        ('oslo_messaging_rabbit', 'kombu_ssl_ca_certs'),
    ('DEFAULT', 'kombu_reconnect_delay'):
        ('oslo_messaging_rabbit', 'kombu_reconnect_delay'),
    ('DEFAULT', 'rabbit_host'):
        ('oslo_messaging_rabbit', 'rabbit_host'),
    ('DEFAULT', 'rabbit_port'):
        ('oslo_messaging_rabbit', 'rabbit_port'),
    ('DEFAULT', 'rabbit_hosts'):
        ('oslo_messaging_rabbit', 'rabbit_hosts'),
    ('DEFAULT', 'rabbit_use_ssl'):
        ('oslo_messaging_rabbit', 'rabbit_use_ssl'),
    ('DEFAULT', 'rabbit_userid'):
        ('oslo_messaging_rabbit', 'rabbit_userid'),
    ('DEFAULT', 'rabbit_password'):
        ('oslo_messaging_rabbit', 'rabbit_password'),
    ('DEFAULT', 'rabbit_login_method'):
        ('oslo_messaging_rabbit', 'rabbit_login_method'),
    ('DEFAULT', 'rabbit_virtual_host'):
        ('oslo_messaging_rabbit', 'rabbit_virtual_host'),
    ('DEFAULT', 'rabbit_retry_backoff'):
        ('oslo_messaging_rabbit', 'rabbit_retry_backoff'),
    ('DEFAULT', 'rabbit_max_retries'):
        ('oslo_messaging_rabbit', 'rabbit_max_retries'),
    ('DEFAULT', 'rabbit_ha_queues'):
        ('oslo_messaging_rabbit', 'rabbit_ha_queues'),
    ('DEFAULT', 'fake_rabbit'):
        ('oslo_messaging_rabbit', 'fake_rabbit'),
    ('DEFAULT', 'osapi_max_request_body_size'):
        ('oslo_middleware', 'max_request_body_size'),
    ('neutron', 'ca_certificates_file'): ('neutron', 'cafile'),
    ('neutron', 'admin_user_id'): (None, None),
    ('neutron', 'admin_tenant_id'): (None, None),
    ('DEFAULT', 'log_format'): (None, None),
    ('cinder', 'api_insecure'): ('cinder', 'insecure'),
    ('DEFAULT', 'share_dhcp_address'): (None, None),
    ('neutron', 'api_insecure'): ('neutron', 'insecure'),
    ('cinder', 'ca_certificates_file'): ('cinder', 'cafile'),
    ('neutron', 'url_timeout'): ('neutron', 'timeout'),
    ('neutron', 'allow_duplicate_networks'): (None, None),
}

NOVA_CONF_EXCEPTIONS = [
    ('DEFAULT', 'ec2_workers'),
    ('DEFAULT', 'osapi_compute_workers'),
    ('DEFAULT', 'metadata_workers'),
    ('DEFAULT', 'lock_path'),
    ('DEFAULT', 'novncproxy_base_url'),
    ('DEFAULT', 'ovs_bridge'),
    ('conductor', 'workers'),
    ('database', 'connection'),
    ('keystone_authtoken', 'auth_uri'),
    ('keystone_authtoken', 'signing_dir'),
    ('keystone_authtoken', 'identity_uri'),
    ('keystone_authtoken', 'admin_user'),
    ('keystone_authtoken', 'admin_password'),
    ('keystone_authtoken', 'admin_tenant_name'),
    ('neutron', 'service_metadata_proxy'),
]


def start():
    # pull out the current version of config/upgrade-id
    p = Popen(['/usr/bin/svcprop', '-p', 'config/upgrade-id',
               os.environ['SMF_FMRI']], stdout=PIPE, stderr=PIPE)
    curr_ver, _err = p.communicate()
    curr_ver = curr_ver.strip()

    # extract the openstack-upgrade-id from the pkg
    p = Popen(['/usr/bin/pkg', 'contents', '-H', '-t', 'set', '-o', 'value',
               '-a', 'name=openstack.upgrade-id',
               'pkg:/cloud/openstack/nova'], stdout=PIPE, stderr=PIPE)
    pkg_ver, _err = p.communicate()
    pkg_ver = pkg_ver.strip()

    if curr_ver == pkg_ver:
        # No need to upgrade
        sys.exit(smf_include.SMF_EXIT_OK)

    # look for any .new files
    if glob.glob('/etc/nova/*.new'):
        # the versions are different, so perform an upgrade
        # modify the configuration files

        # backup all the old configuration files
        create_backups('/etc/nova')

        modify_conf('/etc/nova/api-paste.ini')
        modify_conf('/etc/nova/logging.conf')

        # It's possible that nova.conf has database.connection commented out
        # (to use the default value).  If it is, and none of other deprecated
        # values are set, manually set database.connection in the new conf
        # file.
        if os.path.exists('/etc/nova/nova.conf.new'):

            # open the previous version
            old = iniparse.ConfigParser()
            old.readfp(open('/etc/nova/nova.conf'))

            # open the new version
            new = iniparse.ConfigParser()
            new.readfp(open('/etc/nova/nova.conf.new'))

            options = [
                ('database', 'sql_connection'),
                ('sql', 'connection'),
                ('database', 'connection'),
                ('DEFAULT', 'sql_connection')
            ]
            test = lambda x: old.has_section(x[0]) and \
                old.has_option(x[0], x[1])

            if not any(map(test, options)):
                if old.has_option('DEFAULT', 'state_path'):
                    state_path = old.get('DEFAULT', 'state_path')
                else:
                    state_path = '/var/lib/nova'

                if old.has_option('DEFAULT', 'sqlite_db'):
                    sqlite_db = old.get('DEFAULT', 'sqlite_db')
                else:
                    sqlite_db = 'nova.sqlite'

                new.set('database', 'connection',
                        'sqlite:///%s/%s' % (state_path, sqlite_db))

                with open('/etc/nova/nova.conf.new', 'w+') as fh:
                    new.write(fh)

        modify_conf('/etc/nova/nova.conf', NOVA_CONF_MAPPINGS,
                    NOVA_CONF_EXCEPTIONS)

    config = iniparse.RawConfigParser()
    config.read('/etc/nova/nova.conf')
    # In certain cases the database section does not exist and the
    # default database chosen is sqlite.
    if config.has_section('database'):
        db_connection = config.get('database', 'connection')

        if db_connection.startswith('mysql'):
            engine = sqlalchemy.create_engine(db_connection)
            if engine.url.username != '%SERVICE_USER%':
                alter_mysql_tables(engine)
                print "altered character set to utf8 in nova tables"

    # update the current version
    check_call(['/usr/sbin/svccfg', '-s', os.environ['SMF_FMRI'], 'setprop',
               'config/upgrade-id', '=', pkg_ver])
    check_call(['/usr/sbin/svccfg', '-s', os.environ['SMF_FMRI'], 'refresh'])

    sys.exit(smf_include.SMF_EXIT_OK)


if __name__ == '__main__':
    os.putenv('LC_ALL', 'C')
    try:
        smf_include.smf_main()
    except RuntimeError:
        sys.exit(smf_include.SMF_EXIT_ERR_FATAL)
    except Exception as err:
        print 'Unknown error:  %s' % err
        print
        traceback.print_exc(file=sys.stdout)
        sys.exit(smf_include.SMF_EXIT_ERR_FATAL)
