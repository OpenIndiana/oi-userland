Backport of:

From d7c3d2cb460be10a3ea7b32e9443a83c243b2251 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Sat, 4 Mar 2017 21:27:39 +0300
Subject: [PATCH] Secunia SA75000 advisory: several buffer overruns

---
 dcraw/dcraw.c             | 12 ++++++++++--
 internal/dcraw_common.cpp | 12 ++++++++++--
 2 files changed, 20 insertions(+), 4 deletions(-)

Index: libraw-0.17.1/dcraw/dcraw.c
===================================================================
--- LibRaw-0.17.2/dcraw/dcraw.c.~4~	2017-11-23 12:49:11.432365749 +0000
+++ LibRaw-0.17.2/dcraw/dcraw.c	2017-11-23 12:53:43.987156274 +0000
@@ -5837,7 +5837,12 @@
 	if (!strcmp(model,"DSLR-A100") && tiff_ifd[ifd].width == 3872) {
 	  load_raw = &CLASS sony_arw_load_raw;
 	  data_offset = get4()+base;
-	  ifd++;  break;
+	  ifd++;
+#ifdef LIBRAW_LIBRARY_BUILD
+	  if (ifd >= sizeof tiff_ifd / sizeof tiff_ifd[0])
+	    throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif    
+	  break;
 	}
 	while (len--) {
 	  i = ftell(ifp);
@@ -6001,7 +6006,8 @@
 	break;
       case 50454:			/* Sinar tag */
       case 50455:
-	if (!(cbuf = (char *) malloc(len))) break;
+	if (len < 1 || len > 2560000 || !(cbuf = (char *) malloc(len)))
+          break;
 	fread (cbuf, 1, len, ifp);
 	for (cp = cbuf-1; cp && cp < cbuf+len; cp = strchr(cp,'\n'))
 	  if (!strncmp (++cp,"Neutral ",8))
@@ -6760,7 +6766,11 @@
     }
     order = get2();
     hlen  = get4();
-    if (get4() == 0x48454150)		/* "HEAP" */
+    if (get4() == 0x48454150
+#ifdef LIBRAW_LIBRARY_BUILD
+       && (save+hlen) >= 0 && (save+hlen)<=ifp->size()
+#endif
+       )		/* "HEAP" */
       parse_ciff (save+hlen, len-hlen, 0);
     if (parse_tiff (save+6)) apply_tiff();
     fseek (ifp, save+len, SEEK_SET);
Index: libraw-0.17.1/internal/dcraw_common.cpp
===================================================================
--- libraw-0.17.1.orig/internal/dcraw_common.cpp	2017-11-16 13:56:17.560204463 -0500
+++ libraw-0.17.1/internal/dcraw_common.cpp	2017-11-16 13:58:15.489480091 -0500
@@ -9057,7 +9057,12 @@ int CLASS parse_tiff_ifd (int base)
 	if (!strcmp(model,"DSLR-A100") && tiff_ifd[ifd].t_width == 3872) {
 	  load_raw = &CLASS sony_arw_load_raw;
 	  data_offset = get4()+base;
-	  ifd++;  break;
+	  ifd++;
+#ifdef LIBRAW_LIBRARY_BUILD
+	  if (ifd >= sizeof tiff_ifd / sizeof tiff_ifd[0])
+	    throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif    
+	  break;
 	}
 #ifdef LIBRAW_LIBRARY_BUILD
 	if (!strncmp(make,"Hasselblad",10) && libraw_internal_data.unpacker_data.hasselblad_parser_flag) {
@@ -9309,7 +9314,8 @@ int CLASS parse_tiff_ifd (int base)
 	break;
       case 50454:			/* Sinar tag */
       case 50455:
-	if (!(cbuf = (char *) malloc(len))) break;
+	if (len < 1 || len > 2560000 || !(cbuf = (char *)malloc(len)))
+	  break;
 #ifndef LIBRAW_LIBRARY_BUILD
 	fread (cbuf, 1, len, ifp);
 #else
@@ -10376,7 +10382,11 @@ int CLASS parse_jpeg (int offset)
     }
     order = get2();
     hlen  = get4();
-    if (get4() == 0x48454150)		/* "HEAP" */
+    if (get4() == 0x48454150
+#ifdef LIBRAW_LIBRARY_BUILD
+	&& (save+hlen) >= 0 && (save+hlen)<=ifp->size()
+#endif
+	) /* "HEAP" */
 		{
 #ifdef LIBRAW_LIBRARY_BUILD
 			imgdata.lens.makernotes.CameraMount = LIBRAW_MOUNT_FixedLens;
