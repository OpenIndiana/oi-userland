Backport of:

From 8303e74b0567806dd5f16fc39aab70fe928de1a2 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Tue, 12 Sep 2017 10:21:15 +0300
Subject: [PATCH] processCanonCameraInfo possible buffer overrun on damaged
 file

---
 Changelog.txt             | 7 +++++--
 dcraw/dcraw.c             | 5 +++--
 internal/dcraw_common.cpp | 5 +++--
 libraw/libraw_version.h   | 2 +-
 4 files changed, 12 insertions(+), 7 deletions(-)

Index: libraw-0.17.1/internal/dcraw_common.cpp
===================================================================
--- libraw-0.17.1.orig/internal/dcraw_common.cpp	2017-11-16 13:59:25.150234599 -0500
+++ libraw-0.17.1/internal/dcraw_common.cpp	2017-11-16 14:01:15.467435147 -0500
@@ -5649,6 +5649,7 @@ void CLASS setCanonBodyFeatures (unsigne
 void CLASS processCanonCameraInfo (unsigned id, uchar *CameraInfo, unsigned maxlen)
 {
   ushort iCanonLensID = 0, iCanonMaxFocal = 0, iCanonMinFocal = 0, iCanonLens = 0, iCanonCurFocal = 0, iCanonFocalType = 0;
+  if(maxlen<16) return; // too short, so broken
   CameraInfo[0] = 0;
   CameraInfo[1] = 0;
   switch (id) {
@@ -6718,7 +6719,7 @@ void CLASS parse_makernote_0xc634(int ba
 
         else if (tag == 0x000d)			// camera info
           {
-            CanonCameraInfo = (uchar*)malloc(len);
+            CanonCameraInfo = (uchar*)malloc(MAX(16,len));
             fread(CanonCameraInfo, len, 1, ifp);
             lenCanonCameraInfo = len;
           }
@@ -7488,7 +7489,7 @@ void CLASS parse_makernote (int base, in
 
         else if (tag == 0x000d)			// camera info
           {
-            CanonCameraInfo = (uchar*)malloc(len);
+            CanonCameraInfo = (uchar*)malloc(MAX(16,len));
             fread(CanonCameraInfo, len, 1, ifp);
             lenCanonCameraInfo = len;
           }
