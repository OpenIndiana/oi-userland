From 82616eff4c7f7437e96bdeeed238c3ef3dc12d60 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Sat, 9 Sep 2017 02:00:00 +0400
Subject: [PATCH] 0.18.3

---
 Changelog.txt             | 13 +++++++++++++
 dcraw/dcraw.c             | 26 +++++++++++++++++++++++++-
 internal/dcraw_common.cpp | 41 +++++++++++++++++++++++++++++++++++++----
 libraw/libraw_version.h   |  2 +-
 4 files changed, 76 insertions(+), 6 deletions(-)

Index: libraw-0.17.1/dcraw/dcraw.c
===================================================================
--- libraw-0.17.1.orig/dcraw/dcraw.c	2017-11-16 13:58:45.317803077 -0500
+++ libraw-0.17.1/dcraw/dcraw.c	2017-11-16 13:58:45.313803034 -0500
@@ -5947,6 +5947,10 @@ void CLASS cielab (ushort rgb[3], short
 void CLASS xtrans_interpolate (int passes)
 {
   int c, d, f, g, h, i, v, ng, row, col, top, left, mrow, mcol;
+#ifdef LIBRAW_LIBRARY_BUILD
+  int cstat[4]={0,0,0,0};
+#endif
+
   int val, ndir, pass, hm[8], avg[4], color[3][8];
   static const short orth[12] = { 1,0,0,1,-1,0,0,-1,1,0,0,1 },
 	patt[2][16] = { { 0,1,0,-1,2,0,-1,0,1,1,1,-1,0,0,0,0 },
@@ -5964,6 +5968,18 @@ void CLASS xtrans_interpolate (int passe
     fprintf (stderr,_("%d-pass X-Trans interpolation...\n"), passes);
 #endif
 
+#ifdef LIBRAW_LIBRARY_BUILD
+/* Check against right pattern */
+  for (row = 0; row < 6; row++)
+         for (col = 0; col < 6; col++)
+                 cstat[fcol(row,col)]++;
+
+  if(cstat[0] < 6 || cstat[0]>10 || cstat[1]< 16 
+    || cstat[1]>24 || cstat[2]< 6 || cstat[2]>10 || cstat[3])
+         throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif
+
+
   cielab (0,0);
   ndir = 4 << (passes > 1);
   buffer = (char *) malloc (TS*TS*(ndir*11+6));
@@ -11529,7 +11545,11 @@ void CLASS parse_fuji (int offset)
       fuji_width = !(fgetc(ifp) & 8);
     } else if (tag == 0x131) {
       filters = 9;
-      FORC(36) xtrans_abs[0][35-c] = fgetc(ifp) & 3;
+      FORC(36)
+        {
+           int q = fgetc(ifp);
+           xtrans_abs[0][35 - c] = MAX(0,MIN(q,2)); /* & 3;*/
+        }
     } else if (tag == 0x2ff0) {
       FORC4 cam_mul[c ^ 1] = get2();
 
Index: libraw-0.17.1/internal/dcraw_common.cpp
===================================================================
--- libraw-0.17.1.orig/internal/dcraw_common.cpp	2017-11-16 13:58:45.317803077 -0500
+++ libraw-0.17.1/internal/dcraw_common.cpp	2017-11-16 13:58:45.317803077 -0500
@@ -4773,6 +4773,10 @@ void CLASS cielab (ushort rgb[3], short
 void CLASS xtrans_interpolate (int passes)
 {
   int c, d, f, g, h, i, v, ng, row, col, top, left, mrow, mcol;
+#ifdef LIBRAW_LIBRARY_BUILD
+  int cstat[4]={0,0,0,0};
+#endif
+
   int val, ndir, pass, hm[8], avg[4], color[3][8];
   static const short orth[12] = { 1,0,0,1,-1,0,0,-1,1,0,0,1 },
 	patt[2][16] = { { 0,1,0,-1,2,0,-1,0,1,1,1,-1,0,0,0,0 },
@@ -4790,6 +4794,18 @@ void CLASS xtrans_interpolate (int passe
     fprintf (stderr,_("%d-pass X-Trans interpolation...\n"), passes);
 #endif
 
+#ifdef LIBRAW_LIBRARY_BUILD
+/* Check against right pattern */
+  for (row = 0; row < 6; row++)
+         for (col = 0; col < 6; col++)
+                 cstat[fcol(row,col)]++;
+
+  if(cstat[0] < 6 || cstat[0]>10 || cstat[1]< 16 
+    || cstat[1]>24 || cstat[2]< 6 || cstat[2]>10 || cstat[3])
+         throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif
+
+
   cielab (0,0);
   ndir = 4 << (passes > 1);
   buffer = (char *) malloc (TS*TS*(ndir*11+6));
@@ -10344,7 +10360,11 @@ void CLASS parse_fuji (int offset)
       fuji_width = !(fgetc(ifp) & 8);
     } else if (tag == 0x131) {
       filters = 9;
-      FORC(36) xtrans_abs[0][35-c] = fgetc(ifp) & 3;
+      FORC(36)
+        {
+           int q = fgetc(ifp);
+           xtrans_abs[0][35 - c] = MAX(0,MIN(q,2)); /* & 3;*/
+        }
     } else if (tag == 0x2ff0) {
       FORC4 cam_mul[c ^ 1] = get2();
 
