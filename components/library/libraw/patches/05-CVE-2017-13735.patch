From 82616eff4c7f7437e96bdeeed238c3ef3dc12d60 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Sat, 9 Sep 2017 02:00:00 +0400
Subject: [PATCH] 0.18.3

---
 Changelog.txt             | 13 +++++++++++++
 dcraw/dcraw.c             | 26 +++++++++++++++++++++++++-
 internal/dcraw_common.cpp | 41 +++++++++++++++++++++++++++++++++++++----
 libraw/libraw_version.h   |  2 +-
 4 files changed, 76 insertions(+), 6 deletions(-)

Index: libraw-0.17.1/dcraw/dcraw.c
===================================================================
--- libraw-0.17.1.orig/dcraw/dcraw.c	2017-11-16 13:58:38.105724971 -0500
+++ libraw-0.17.1/dcraw/dcraw.c	2017-11-16 13:58:38.101724928 -0500
@@ -2796,6 +2796,10 @@ void CLASS kodak_radc_load_raw()
     checkCancel();
 #endif
     FORC3 mul[c] = getbits(6);
+#ifdef LIBRAW_LIBRARY_BUILD
+    if(!mul[0] || !mul[1] || !mul[2])
+      throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif
     FORC3 {
       val = ((0x1000000/last[c] + 0x7ff) >> 12) * mul[c];
       s = val > 65564 ? 10:12;
Index: libraw-0.17.1/internal/dcraw_common.cpp
===================================================================
--- libraw-0.17.1.orig/internal/dcraw_common.cpp	2017-11-16 13:58:38.105724971 -0500
+++ libraw-0.17.1/internal/dcraw_common.cpp	2017-11-16 13:58:38.105724971 -0500
@@ -2512,6 +2512,10 @@ void CLASS kodak_radc_load_raw()
     checkCancel();
 #endif
     FORC3 mul[c] = getbits(6);
+#ifdef LIBRAW_LIBRARY_BUILD
+    if(!mul[0] || !mul[1] || !mul[2])
+      throw LIBRAW_EXCEPTION_IO_CORRUPT;
+#endif
     FORC3 {
       val = ((0x1000000/last[c] + 0x7ff) >> 12) * mul[c];
       s = val > 65564 ? 10:12;
