From d13e8f6d1e987b7491182040a188c16a395f1d21 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Wed, 13 Sep 2017 09:31:01 +0300
Subject: [PATCH] CVE-2017-1438 credits; fix for Kodak 65000 out of bounds
 access

---
 Changelog.txt             |  6 +++++-
 dcraw/dcraw.c             | 11 +++++++++--
 internal/dcraw_common.cpp | 11 +++++++++--
 3 files changed, 23 insertions(+), 5 deletions(-)

Index: libraw-0.17.1/dcraw/dcraw.c
===================================================================
--- libraw-0.17.1.orig/dcraw/dcraw.c	2017-11-16 14:02:06.780004500 -0500
+++ libraw-0.17.1/dcraw/dcraw.c	2017-11-16 14:02:06.772004409 -0500
@@ -3320,8 +3320,15 @@ void CLASS kodak_65000_load_raw()
       len = MIN (256, width-col);
       ret = kodak_65000_decode (buf, len);
       for (i=0; i < len; i++)
-	if ((RAW(row,col+i) =	curve[ret ? buf[i] :
-		(pred[i & 1] += buf[i])]) >> 12) derror();
+      {
+	int idx = ret ? buf[i] : (pred[i & 1] += buf[i]);
+	if(idx >=0 && idx <= 0xffff)
+	 {
+	   if ((RAW(row,col+i) = curve[idx]) >> 12) derror();
+         }
+	 else
+	   derror();
+      }
     }
   }
 }
Index: libraw-0.17.1/internal/dcraw_common.cpp
===================================================================
--- libraw-0.17.1.orig/internal/dcraw_common.cpp	2017-11-16 14:02:06.780004500 -0500
+++ libraw-0.17.1/internal/dcraw_common.cpp	2017-11-16 14:02:06.776004455 -0500
@@ -3036,8 +3036,15 @@ void CLASS kodak_65000_load_raw()
       len = MIN (256, width-col);
       ret = kodak_65000_decode (buf, len);
       for (i=0; i < len; i++)
-	if ((RAW(row,col+i) =	curve[ret ? buf[i] :
-		(pred[i & 1] += buf[i])]) >> 12) derror();
+      {
+	int idx = ret ? buf[i] : (pred[i & 1] += buf[i]);
+	if(idx >=0 && idx <= 0xffff)
+	 {
+	   if ((RAW(row,col+i) = curve[idx]) >> 12) derror();
+         }
+	 else
+	   derror();
+      }
     }
   }
 }
