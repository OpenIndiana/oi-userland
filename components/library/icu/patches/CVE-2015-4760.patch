Description: fix denial of service and possible code execution via overflows
Origin: other, http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/3f9845510b47
Bug: http://bugs.icu-project.org/trac/ticket/11865

Index: icu-52.1/source/layout/ContextualGlyphInsertionProc2.cpp
===================================================================
--- icu-52.1.orig/source/layout/ContextualGlyphInsertionProc2.cpp	2013-10-04 16:54:54.000000000 -0400
+++ icu-52.1/source/layout/ContextualGlyphInsertionProc2.cpp	2015-09-11 08:46:42.275331792 -0400
@@ -82,6 +82,10 @@
     
     le_int16 markIndex = SWAPW(entry->markedInsertionListIndex);
     if (markIndex > 0) {
+        if (markGlyph < 0 || markGlyph >= glyphStorage.getGlyphCount()) {
+           success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+           return 0;
+        }
         le_int16 count = (flags & cgiMarkedInsertCountMask) >> 5;
         le_bool isKashidaLike = (flags & cgiMarkedIsKashidaLike);
         le_bool isBefore = (flags & cgiMarkInsertBefore);
@@ -90,6 +94,10 @@
 
     le_int16 currIndex = SWAPW(entry->currentInsertionListIndex);
     if (currIndex > 0) {
+        if (currGlyph < 0 || currGlyph >= glyphStorage.getGlyphCount()) {
+           success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+           return 0;
+        }
         le_int16 count = flags & cgiCurrentInsertCountMask;
         le_bool isKashidaLike = (flags & cgiCurrentIsKashidaLike);
         le_bool isBefore = (flags & cgiCurrentInsertBefore);
Index: icu-52.1/source/layout/ContextualGlyphSubstProc.cpp
===================================================================
--- icu-52.1.orig/source/layout/ContextualGlyphSubstProc.cpp	2013-10-04 16:54:50.000000000 -0400
+++ icu-52.1/source/layout/ContextualGlyphSubstProc.cpp	2015-09-11 08:46:42.275331792 -0400
@@ -51,6 +51,10 @@
   WordOffset currOffset = SWAPW(entry->currOffset);
   
   if (markOffset != 0 && LE_SUCCESS(success)) {
+    if (markGlyph < 0 || markGlyph >= glyphStorage.getGlyphCount()) {
+       success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+       return 0;
+    }
     LEGlyphID mGlyph = glyphStorage[markGlyph];
     TTGlyphID newGlyph = SWAPW(int16Table.getObject(markOffset + LE_GET_GLYPH(mGlyph), success)); // whew. 
 
@@ -58,6 +62,10 @@
   }
 
   if (currOffset != 0) {
+    if (currGlyph < 0 || currGlyph >= glyphStorage.getGlyphCount()) {
+       success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+       return 0;
+    }
     LEGlyphID thisGlyph = glyphStorage[currGlyph];
     TTGlyphID newGlyph = SWAPW(int16Table.getObject(currOffset + LE_GET_GLYPH(thisGlyph), success)); // whew. 
     
Index: icu-52.1/source/layout/ContextualGlyphSubstProc2.cpp
===================================================================
--- icu-52.1.orig/source/layout/ContextualGlyphSubstProc2.cpp	2013-10-04 16:54:52.000000000 -0400
+++ icu-52.1/source/layout/ContextualGlyphSubstProc2.cpp	2015-09-11 08:46:42.275331792 -0400
@@ -45,17 +45,25 @@
     if(LE_FAILURE(success)) return 0;
     le_uint16 newState = SWAPW(entry->newStateIndex);
     le_uint16 flags = SWAPW(entry->flags);
-    le_int16 markIndex = SWAPW(entry->markIndex);
-    le_int16 currIndex = SWAPW(entry->currIndex);
+    le_uint16 markIndex = SWAPW(entry->markIndex);
+    le_uint16 currIndex = SWAPW(entry->currIndex);
     
-    if (markIndex != -1) {
+    if (markIndex != 0x0FFFF) {
+        if (markGlyph < 0 || markGlyph >= glyphStorage.getGlyphCount()) {
+           success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+           return 0;
+        }
         le_uint32 offset = SWAPL(perGlyphTable(markIndex, success));
         LEGlyphID mGlyph = glyphStorage[markGlyph];
         TTGlyphID newGlyph = lookup(offset, mGlyph, success);        
         glyphStorage[markGlyph] = LE_SET_GLYPH(mGlyph, newGlyph);
     }
 
-    if (currIndex != -1) {
+    if (currIndex != 0x0FFFF) {
+        if (currGlyph < 0 || currGlyph >= glyphStorage.getGlyphCount()) {
+           success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+           return 0;
+        }
         le_uint32 offset = SWAPL(perGlyphTable(currIndex, success));
         LEGlyphID thisGlyph = glyphStorage[currGlyph];
         TTGlyphID newGlyph = lookup(offset, thisGlyph, success);
Index: icu-52.1/source/layout/IndicRearrangementProcessor.cpp
===================================================================
--- icu-52.1.orig/source/layout/IndicRearrangementProcessor.cpp	2013-10-04 16:54:54.000000000 -0400
+++ icu-52.1/source/layout/IndicRearrangementProcessor.cpp	2015-09-11 08:46:42.275331792 -0400
@@ -45,6 +45,11 @@
     ByteOffset newState = SWAPW(entry->newStateOffset);
     IndicRearrangementFlags flags = (IndicRearrangementFlags) SWAPW(entry->flags);
 
+    if (currGlyph < 0 || currGlyph >= glyphStorage.getGlyphCount()) {
+       success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+       return 0;
+    }
+
     if (flags & irfMarkFirst) {
         firstGlyph = currGlyph;
     }
Index: icu-52.1/source/layout/IndicRearrangementProcessor2.cpp
===================================================================
--- icu-52.1.orig/source/layout/IndicRearrangementProcessor2.cpp	2013-10-04 16:54:56.000000000 -0400
+++ icu-52.1/source/layout/IndicRearrangementProcessor2.cpp	2015-09-11 08:46:42.279331836 -0400
@@ -43,6 +43,11 @@
     le_uint16 newState = SWAPW(entry->newStateIndex); // index to the new state
     IndicRearrangementFlags  flags =  (IndicRearrangementFlags) SWAPW(entry->flags);
     
+    if (currGlyph < 0 || currGlyph >= glyphStorage.getGlyphCount()) {
+       success = LE_INDEX_OUT_OF_BOUNDS_ERROR;
+       return 0;
+    }
+
     if (flags & irfMarkFirst) {
         firstGlyph = currGlyph;
     }
Index: icu-52.1/source/layout/LigatureSubstProc.cpp
===================================================================
--- icu-52.1.orig/source/layout/LigatureSubstProc.cpp	2013-10-04 16:54:52.000000000 -0400
+++ icu-52.1/source/layout/LigatureSubstProc.cpp	2015-09-11 08:46:42.279331836 -0400
@@ -48,7 +48,7 @@
   const LigatureSubstitutionStateEntry *entry = entryTable.getAlias(index, success);
 
     ByteOffset newState = SWAPW(entry->newStateOffset);
-    le_int16 flags = SWAPW(entry->flags);
+    le_uint16 flags = SWAPW(entry->flags);
 
     if (flags & lsfSetComponent) {
         if (++m >= nComponents) {
Index: icu-52.1/source/layout/StateTableProcessor.cpp
===================================================================
--- icu-52.1.orig/source/layout/StateTableProcessor.cpp	2013-10-04 16:54:54.000000000 -0400
+++ icu-52.1/source/layout/StateTableProcessor.cpp	2015-09-11 08:46:42.283331881 -0400
@@ -60,6 +60,7 @@
         if (currGlyph == glyphCount) {
             // XXX: How do we handle EOT vs. EOL?
             classCode = classCodeEOT;
+            break;
         } else {
             TTGlyphID glyphCode = (TTGlyphID) LE_GET_GLYPH(glyphStorage[currGlyph]);
 
Index: icu-52.1/source/layout/StateTableProcessor2.cpp
===================================================================
--- icu-52.1.orig/source/layout/StateTableProcessor2.cpp	2013-10-04 16:54:56.000000000 -0400
+++ icu-52.1/source/layout/StateTableProcessor2.cpp	2015-09-11 08:46:42.287331925 -0400
@@ -78,6 +78,7 @@
                 if (currGlyph == glyphCount || currGlyph == -1) {
                     // XXX: How do we handle EOT vs. EOL?
                     classCode = classCodeEOT;
+                    break;
                 } else {
                     LEGlyphID gid = glyphStorage[currGlyph];
                     TTGlyphID glyphCode = (TTGlyphID) LE_GET_GLYPH(gid);
@@ -109,6 +110,7 @@
                 if (currGlyph == glyphCount || currGlyph == -1) {
                     // XXX: How do we handle EOT vs. EOL?
                     classCode = classCodeEOT;
+                    break;
                 } else {
                     LEGlyphID gid = glyphStorage[currGlyph];
                     TTGlyphID glyphCode = (TTGlyphID) LE_GET_GLYPH(gid);
@@ -146,6 +148,7 @@
                 if (currGlyph == glyphCount || currGlyph == -1) {
                     // XXX: How do we handle EOT vs. EOL?
                     classCode = classCodeEOT;
+                    break;
                 } else if(currGlyph > glyphCount) {
                   // note if > glyphCount, we've run off the end (bad font)
                   currGlyph = glyphCount;
@@ -186,6 +189,7 @@
                 if (currGlyph == glyphCount || currGlyph == -1) {
                     // XXX: How do we handle EOT vs. EOL?
                     classCode = classCodeEOT;
+                    break;
                 } else {
                     TTGlyphID glyphCode = (TTGlyphID) LE_GET_GLYPH(glyphStorage[currGlyph]);
                     if (glyphCode == 0xFFFF) {
Index: icu-52.1/source/layout/StateTables.h
===================================================================
--- icu-52.1.orig/source/layout/StateTables.h	2013-10-04 16:54:54.000000000 -0400
+++ icu-52.1/source/layout/StateTables.h	2015-09-11 08:46:42.291331970 -0400
@@ -101,7 +101,7 @@
 struct StateEntry
 {
     ByteOffset  newStateOffset;
-    le_int16    flags;
+    le_uint16    flags;
 };
 
 typedef le_uint16 EntryTableIndex2;
