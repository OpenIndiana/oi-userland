From 9657bbe3cdce4aaa90e07d50c1c70ae52da0ba6a Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Sat, 3 Dec 2016 11:35:56 +0000
Subject: [PATCH] * tools/tiffcrop.c: fix readContigStripsIntoBuffer() in -i
 (ignore) mode so that the output buffer is correctly incremented to avoid
 write outside bounds. Reported by Agostino Sarubbo. Fixes
 http://bugzilla.maptools.org/show_bug.cgi?id=2620

---
 ChangeLog        | 7 +++++++
 tools/tiffcrop.c | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

#diff --git a/ChangeLog b/ChangeLog
#index 5b23665..d6a416b 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,5 +1,12 @@
# 2016-12-03 Even Rouault <even.rouault at spatialys.com>
# 
#+	* tools/tiffcrop.c: fix readContigStripsIntoBuffer() in -i (ignore) mode so
#+	that the output buffer is correctly incremented to avoid write outside bounds.
#+	Reported by Agostino Sarubbo.
#+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2620
#+
#+2016-12-03 Even Rouault <even.rouault at spatialys.com>
#+
# 	* libtiff/tif_ojpeg.c: make OJPEGDecode() early exit in case of failure in
# 	OJPEGPreDecode(). This will avoid a divide by zero, and potential other issues.
# 	Reported by Agostino Sarubbo.
Index: tiff-4.0.6/tools/tiffcrop.c
===================================================================
--- tiff-4.0.6.orig/tools/tiffcrop.c	2017-02-24 10:18:32.437033026 -0500
+++ tiff-4.0.6/tools/tiffcrop.c	2017-02-24 10:18:32.433032976 -0500
@@ -3697,7 +3697,7 @@
                                   (unsigned long) strip, (unsigned long)rows);
                         return 0;
                 }
-                bufp += bytes_read;
+                bufp += stripsize;
         }
 
         return 1;
