Backport of:

From d7348bab602cf4dbdf65b9eeba2fb9ce4646bc0b Mon Sep 17 00:00:00 2001
From: Azat Khuzhin <a3at.mail@gmail.com>
Date: Fri, 25 Mar 2016 00:21:06 +0300
Subject: [PATCH] test/dns: regression for empty hostname

Refs: #332
---
 test/regress_dns.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

Index: libevent-2.0.21-stable/test/regress_dns.c
===================================================================
--- libevent-2.0.21-stable.orig/test/regress_dns.c	2017-03-10 14:11:11.871737631 -0500
+++ libevent-2.0.21-stable/test/regress_dns.c	2017-03-10 14:11:46.852168776 -0500
@@ -506,6 +506,26 @@
 };
 
 static void
+dns_search_empty_test(void *arg)
+{
+	struct basic_test_data *data = arg;
+	struct event_base *base = data->base;
+	struct evdns_base *dns = NULL;
+
+	dns = evdns_base_new(base, 0);
+
+	evdns_base_search_add(dns, "whatever.example.com");
+
+	n_replies_left = 1;
+	exit_base = base;
+
+	tt_ptr_op(evdns_base_resolve_ipv4(dns, "", 0, generic_dns_callback, NULL), ==, NULL);
+
+end:
+	if (dns)
+		evdns_base_free(dns, 0);
+}
+static void
 dns_search_test(void *arg)
 {
 	struct basic_test_data *data = arg;
@@ -1831,6 +1851,7 @@
 	DNS_LEGACY(gethostbyname6, TT_FORK|TT_NEED_BASE|TT_NEED_DNS),
 	DNS_LEGACY(gethostbyaddr, TT_FORK|TT_NEED_BASE|TT_NEED_DNS),
 	{ "resolve_reverse", dns_resolve_reverse, TT_FORK, NULL, NULL },
+	{ "search_empty", dns_search_empty_test, TT_FORK|TT_NEED_BASE, &basic_setup, NULL },
 	{ "search", dns_search_test, TT_FORK|TT_NEED_BASE, &basic_setup, NULL },
 	{ "search_cancel", dns_search_cancel_test,
 	  TT_FORK|TT_NEED_BASE, &basic_setup, NULL },
