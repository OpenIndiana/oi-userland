--- libproxy-0.3.1/src/lib/pac.c.orig	2013-07-04 10:07:17.786690544 +0530
+++ libproxy-0.3.1/src/lib/pac.c	2013-07-04 11:05:17.467820004 +0530
@@ -169,7 +169,7 @@ px_pac_reload(pxPAC *self)
 		}
 
 		/* Get content */
-		if ((!content_length && !chunked) || !correct_mime_type) goto error;
+		if ((content_length == 0 && !chunked) || content_length > PAC_MAX_SIZE || !correct_mime_type) goto error;
 		px_free(line); line = NULL;
 		px_free(self->cache);
 
@@ -198,12 +198,12 @@ px_pac_reload(pxPAC *self)
                                 // Add this chunk to our content length,
                                 // ensuring that we aren't over our max size
                                 content_length += chunk_length;
-                                if (content_length >= PAC_MAX_SIZE) break;
                         }
+			if (content_length >= PAC_MAX_SIZE) break;
 
                         while (recvd != content_length) {
                                 int r = recv(sock, self->cache + recvd, content_length - recvd, 0);
-                                if (r < 0) break;
+                                if (r <= 0) goto error;
                                 recvd += r;
                         }
                         *(self->cache + content_length) = '\0';
