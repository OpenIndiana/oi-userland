Backport of:

From 661a676e556fef17e53c09b9e2656adc80eb0acf Mon Sep 17 00:00:00 2001
From: "Daniel P. Berrange" <berrange@redhat.com>
Date: Thu, 2 Feb 2017 18:01:53 +0000
Subject: Don't accept color map entries for true-color pixel format

The color map entries should only be sent by the server
when true-color flag is false.

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
---
 src/vncconnection.c     |  5 +++
 src/vncconnectiontest.c | 96 +++++++++++++++++++++++++++++++++++++++++++++++--
 2 files changed, 99 insertions(+), 2 deletions(-)

Index: gtk-vnc-0.5.3/src/vncconnection.c
===================================================================
--- gtk-vnc-0.5.3.orig/src/vncconnection.c	2017-02-17 13:20:08.653229377 -0500
+++ gtk-vnc-0.5.3/src/vncconnection.c	2017-02-17 13:24:32.156409941 -0500
@@ -3094,6 +3094,12 @@
         VncColorMap *map;
         int i;
 
+        if (priv->fmt.true_color_flag) {
+            VNC_DEBUG("Got color map entries in true-color pix format");
+            priv->has_error = TRUE;
+            break;
+        }
+
         vnc_connection_read(conn, pad, 1);
         first_color = vnc_connection_read_u16(conn);
         n_colors = vnc_connection_read_u16(conn);
