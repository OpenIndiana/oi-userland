Backport of:

From c8583fd3783c5b811590fcb7bae4ce6e7344963e Mon Sep 17 00:00:00 2001
From: "Daniel P. Berrange" <berrange@redhat.com>
Date: Thu, 2 Feb 2017 18:18:48 +0000
Subject: Correctly validate color map range indexes

The color map index could wrap around to zero causing negative
array index accesses.

https://bugzilla.gnome.org/show_bug.cgi?id=778050

CVE-2017-5885

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
---
 src/vnccolormap.c       |  4 +--
 src/vncconnection.c     | 18 +++++++++---
 src/vncconnectiontest.c | 76 +++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 92 insertions(+), 6 deletions(-)

Index: gtk-vnc-0.5.3/src/vnccolormap.c
===================================================================
--- gtk-vnc-0.5.3.orig/src/vnccolormap.c	2017-02-17 13:24:49.760622372 -0500
+++ gtk-vnc-0.5.3/src/vnccolormap.c	2017-02-17 13:24:49.756622324 -0500
@@ -77,7 +77,7 @@
                            guint16 green,
                            guint16 blue)
 {
-    if (idx >= (map->size + map->offset))
+    if (idx < map->offset || idx >= (map->size + map->offset))
         return FALSE;
 
     map->colors[idx - map->offset].red = red;
@@ -94,7 +94,7 @@
                               guint16 *green,
                               guint16 *blue)
 {
-    if (idx >= (map->size + map->offset))
+    if (idx < map->offset || idx >= (map->size + map->offset))
         return FALSE;
 
     *red = map->colors[idx - map->offset].red;
Index: gtk-vnc-0.5.3/src/vncconnection.c
===================================================================
--- gtk-vnc-0.5.3.orig/src/vncconnection.c	2017-02-17 13:24:49.760622372 -0500
+++ gtk-vnc-0.5.3/src/vncconnection.c	2017-02-17 13:26:10.473596253 -0500
@@ -3106,8 +3106,14 @@
 
         VNC_DEBUG("Colour map from %d with %d entries",
                   first_color, n_colors);
-        map = vnc_color_map_new(first_color, n_colors);
 
+        if (first_color > (65536 - n_colors)) {
+            VNC_DEBUG("Colormap start %d out of range %d", first_color, 65536 - n_colors);
+            priv->has_error = TRUE;
+            break;
+        }
+
+        map = vnc_color_map_new(first_color, n_colors);
         for (i = 0; i < n_colors; i++) {
             guint16 red, green, blue;
 
@@ -3115,9 +3121,15 @@
             green = vnc_connection_read_u16(conn);
             blue = vnc_connection_read_u16(conn);
 
-            vnc_color_map_set(map,
-                              i + first_color,
-                              red, green, blue);
+            if (!vnc_color_map_set(map,
+                                   i + first_color,
+                                   red, green, blue)) {
+                /* Should not be reachable given earlier range check */
+                VNC_DEBUG("Colormap index %d out of range %d,%d",
+                          i + first_color, first_color, 65536 - n_colors);
+                priv->has_error = TRUE;
+                break;
+            }
         }
 
         vnc_framebuffer_set_color_map(priv->fb, map);
