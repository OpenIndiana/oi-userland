Backport of:

From ea0386933214c9178aaea9f2f85049ea3fa3e14a Mon Sep 17 00:00:00 2001
From: "Daniel P. Berrange" <berrange@redhat.com>
Date: Thu, 2 Feb 2017 17:34:47 +0000
Subject: Fix bounds checking for RRE, hextile & copyrect encodings

While the client would bounds check the overall update
region, it failed to bounds check the payload data
parameters.

Add a test case to validate bounds checking.

https://bugzilla.gnome.org/show_bug.cgi?id=778048

CVE-2017-5884

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
---
 cfg.mk                  |   2 +-
 src/Makefile.am         |   8 +
 src/vncconnection.c     |  41 +++--
 src/vncconnectiontest.c | 462 ++++++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 496 insertions(+), 17 deletions(-)
 create mode 100644 src/vncconnectiontest.c

Index: gtk-vnc-0.5.3/src/vncconnection.c
===================================================================
--- gtk-vnc-0.5.3.orig/src/vncconnection.c	2017-02-17 13:10:19.754118446 -0500
+++ gtk-vnc-0.5.3/src/vncconnection.c	2017-02-17 13:10:53.606527352 -0500
@@ -1926,7 +1926,6 @@
     (vnc_connection_tight_sum_pixel_func *)vnc_connection_tight_sum_pixel_32x32,
 };
 
-
 static void vnc_connection_raw_update(VncConnection *conn,
                                       guint16 x, guint16 y,
                                       guint16 width, guint16 height)
@@ -1963,6 +1962,23 @@
     }
 }
 
+
+static gboolean vnc_connection_validate_boundary(VncConnection *conn,
+                                                 guint16 x, guint16 y,
+                                                 guint16 width, guint16 height)
+{
+    VncConnectionPrivate *priv = conn->priv;
+
+    if ((x + width) > priv->width || (y + height) > priv->height) {
+        VNC_DEBUG("Framebuffer update %dx%d at %d,%d outside boundary %dx%d",
+                  width, height, x, y, priv->width, priv->height);
+        priv->has_error = TRUE;
+    }
+
+    return !vnc_connection_has_error(conn);
+}
+
+
 static void vnc_connection_copyrect_update(VncConnection *conn,
                                            guint16 dst_x, guint16 dst_y,
                                            guint16 width, guint16 height)
@@ -1973,6 +1989,9 @@
     src_x = vnc_connection_read_u16(conn);
     src_y = vnc_connection_read_u16(conn);
 
+    if (!vnc_connection_validate_boundary(conn, src_x, src_y, width, height))
+        return;
+
     vnc_framebuffer_copyrect(priv->fb,
                              src_x, src_y,
                              dst_x, dst_y,
@@ -2015,6 +2034,10 @@
                 xy = vnc_connection_read_u8(conn);
                 wh = vnc_connection_read_u8(conn);
 
+                if (!vnc_connection_validate_boundary(conn, x + nibhi(xy), y + niblo(xy),
+                                                      nibhi(wh) + 1, niblo(wh) + 1))
+                    return;
+
                 vnc_framebuffer_fill(priv->fb, fg,
                                      x + nibhi(xy), y + niblo(xy),
                                      nibhi(wh) + 1, niblo(wh) + 1);
@@ -2071,6 +2094,9 @@
         sub_w = vnc_connection_read_u16(conn);
         sub_h = vnc_connection_read_u16(conn);
 
+        if (!vnc_connection_validate_boundary(conn, x + sub_x, y + sub_y, sub_w, sub_h))
+            break;
+
         vnc_framebuffer_fill(priv->fb, fg,
                              x + sub_x, y + sub_y, sub_w, sub_h);
     }
@@ -2838,22 +2864,6 @@
 }
 
 
-static gboolean vnc_connection_validate_boundary(VncConnection *conn,
-                                                 guint16 x, guint16 y,
-                                                 guint16 width, guint16 height)
-{
-    VncConnectionPrivate *priv = conn->priv;
-
-    if ((x + width) > priv->width || (y + height) > priv->height) {
-        VNC_DEBUG("Framebuffer update %dx%d at %d,%d outside boundary %dx%d",
-                  width, height, x, y, priv->width, priv->height);
-        priv->has_error = TRUE;
-    }
-
-    return !vnc_connection_has_error(conn);
-}
-
-
 static gboolean vnc_connection_framebuffer_update(VncConnection *conn, gint32 etype,
                                                   guint16 x, guint16 y,
                                                   guint16 width, guint16 height)
