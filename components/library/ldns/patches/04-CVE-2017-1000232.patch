From 3bdeed02505c9bbacb3b64a97ddcb1de967153b7 Mon Sep 17 00:00:00 2001
From: Willem Toorop <willem@nlnetlabs.nl>
Date: Thu, 27 Apr 2017 00:25:20 +0200
Subject: bugfix #1257: Free after reallocing to 0 size

Thanks Stephan Zeisberg
---
 Changelog  | 2 ++
 str2host.c | 6 ++++--
 2 files changed, 6 insertions(+), 2 deletions(-)

#diff --git a/Changelog b/Changelog
#index 7786148..d7aa711 100644
#--- a/Changelog
#+++ b/Changelog
#@@ -1,4 +1,6 @@
# 1.7.1	????-??-??
#+	* bugfix #1257: Free after reallocing to 0 size
#+	  Thanks Stephan Zeisberg
# 	* bugfix #1256: Check parse limit before t increment
# 	  Thanks Stephan Zeisberg
# 	* bugfix #1245: Only one signature per RRset needs to be valid with
Index: ldns-1.6.17/str2host.c
===================================================================
--- ldns-1.6.17.orig/str2host.c	2017-11-21 13:11:41.185514949 -0500
+++ ldns-1.6.17/str2host.c	2017-11-21 13:11:41.169514774 -0500
@@ -1458,8 +1458,10 @@ ldns_str2rdf_long_str(ldns_rdf **rd, con
 	if (! str) {
 		return LDNS_STATUS_SYNTAX_BAD_ESCAPE;
 	}
-	length = (size_t)(dp - data);
-
+	if (!(length = (size_t)(dp - data))) {
+		LDNS_FREE(data);
+		return LDNS_STATUS_SYNTAX_EMPTY;
+	}
 	/* Lose the overmeasure */
 	data = LDNS_XREALLOC(dp = data, uint8_t, length);
 	if (! data) {
