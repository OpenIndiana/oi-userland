Backport of:

From 7dec871f82e205107a81281e3286f0aa9caa93b3 Mon Sep 17 00:00:00 2001
From: Nikos Mavrogiannopoulos <nmav@redhat.com>
Date: Wed, 4 Jan 2017 14:56:50 +0100
Subject: [PATCH] opencdk: cdk_pk_get_keyid: fix stack overflow

Issue found using oss-fuzz:
  https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=340

Signed-off-by: Nikos Mavrogiannopoulos <nmav@redhat.com>
---
 lib/opencdk/pubkey.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

Index: gnutls26-2.12.23/lib/opencdk/pubkey.c
===================================================================
--- gnutls26-2.12.23.orig/lib/opencdk/pubkey.c	2017-01-26 13:37:35.380629600 -0500
+++ gnutls26-2.12.23/lib/opencdk/pubkey.c	2017-01-26 13:38:29.909331575 -0500
@@ -537,6 +537,7 @@
 {
   u32 lowbits = 0;
   byte buf[24];
+  int rc;
 
   if (pk && (!pk->keyid[0] || !pk->keyid[1]))
     {
@@ -546,7 +547,12 @@
           size_t n;
 
           n = MAX_MPI_BYTES;
-          _gnutls_mpi_print (pk->mpi[0], p, &n);
+          rc = _gnutls_mpi_print(pk->mpi[0], p, &n);
+          if (rc < 0 || n < 8) {
+            keyid[0] = keyid[1] = (u32)-1;
+            return (u32)-1;
+          }
+
           pk->keyid[0] =
             p[n - 8] << 24 | p[n - 7] << 16 | p[n - 6] << 8 | p[n - 5];
           pk->keyid[1] =
