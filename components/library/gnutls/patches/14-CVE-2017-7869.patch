Backport of:

From 51464af713d71802e3c6d5ac15f1a95132a354fe Mon Sep 17 00:00:00 2001
From: Nikos Mavrogiannopoulos <nmav@redhat.com>
Date: Mon, 20 Feb 2017 11:13:08 +0100
Subject: [PATCH] cdk_pkt_read: enforce packet limits

That ensures that there are no overflows in the subsequent
calculations.

Resolves the oss-fuzz found bug:
https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=420

Relates: #159

Signed-off-by: Nikos Mavrogiannopoulos <nmav@redhat.com>
---
 lib/opencdk/read-packet.c |  9 +++++++++
 1 file changed, 9 insertions(+)

Index: gnutls26-2.12.23/lib/opencdk/read-packet.c
===================================================================
--- gnutls26-2.12.23.orig/lib/opencdk/read-packet.c	2017-06-12 09:33:12.681107378 -0400
+++ gnutls26-2.12.23/lib/opencdk/read-packet.c	2017-06-12 09:33:54.785612802 -0400
@@ -978,6 +978,7 @@ skip_packet (cdk_stream_t inp, size_t pk
   assert (pktlen == 0);
 }
 
+#define MAX_PACKET_LEN (1<<24)
 
 /**
  * cdk_pkt_read:
@@ -1035,6 +1036,13 @@ cdk_pkt_read (cdk_stream_t inp, cdk_pack
   else
     read_old_length (inp, ctb, &pktlen, &pktsize);
 
+  /* enforce limits to ensure that the following calculations
+   * do not overflow */
+  if (pktlen >= MAX_PACKET_LEN || pktsize >= MAX_PACKET_LEN) {
+    _cdk_log_info("cdk_pkt_read: too long packet\n");
+    return gnutls_assert_val(CDK_Inv_Packet);
+  }
+
   pkt->pkttype = pkttype;
   pkt->pktlen = pktlen;
   pkt->pktsize = pktsize + pktlen;
