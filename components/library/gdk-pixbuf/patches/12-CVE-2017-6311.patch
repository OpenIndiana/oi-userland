From 758655315bc3760c2d646e1e935f7448847073af Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 27 Jul 2017 13:27:47 +0100
Subject: ico: Return an error when the ICO didn't load

If we don't even read enough data to fill the header, return an
error. This doesn't cover everything that could go wrong with
the ICO incremental loader, but this is a good first throw.

https://bugzilla.gnome.org/show_bug.cgi?id=778204
---
 gdk-pixbuf/io-ico.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

Index: gdk-pixbuf-2.32.2/gdk-pixbuf/io-ico.c
===================================================================
--- gdk-pixbuf-2.32.2.orig/gdk-pixbuf/io-ico.c
+++ gdk-pixbuf-2.32.2/gdk-pixbuf/io-ico.c
@@ -587,6 +587,7 @@ gdk_pixbuf__ico_image_stop_load(gpointer
 {
 	struct ico_progressive_state *context =
 	    (struct ico_progressive_state *) data;
+	gboolean ret = TRUE;
 
         /* FIXME this thing needs to report errors if
          * we have unused image data
@@ -594,8 +595,16 @@ gdk_pixbuf__ico_image_stop_load(gpointer
 
 	g_return_val_if_fail(context != NULL, TRUE);
 
+	if (context->HeaderDone < context->HeaderSize) {
+		g_set_error_literal (error,
+				     GDK_PIXBUF_ERROR,
+				     GDK_PIXBUF_ERROR_CORRUPT_IMAGE,
+				     _("ICO image was truncated or incomplete."));
+		ret = FALSE;
+	}
+
 	context_free (context);
-        return TRUE;
+        return ret;
 }
 
 static void
