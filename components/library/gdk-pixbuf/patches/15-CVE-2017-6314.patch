From 1e513abdb55529f888233d3c96b27352d83aad5f Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 5 Dec 2017 10:26:49 +0100
Subject: [PATCH] tiff: Avoid overflowing buffer size computation

Use g_uint_checked_mul() to avoid overflowing the guint used for buffer
size calculation.

https://bugzilla.gnome.org/show_bug.cgi?id=779020
---
 gdk-pixbuf/io-tiff.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

--- gdk-pixbuf-2.31.6/gdk-pixbuf/io-tiff.c.~2~	2018-01-16 22:19:50.927208007 +0000
+++ gdk-pixbuf-2.31.6/gdk-pixbuf/io-tiff.c	2018-01-16 22:20:49.864524813 +0000
@@ -497,6 +497,10 @@
         return retval;
 }
 
+/* Available in glib since 2.48 */
+static inline gboolean _g_uint_checked_mul (guint32 *dest, guint32 a, guint32 b) {
+  *dest = a * b; return !a || *dest / a == b; }
+
 static gboolean
 make_available_at_least (TiffContext *context, guint needed)
 {
@@ -506,8 +510,15 @@
         need_alloc = context->used + needed;
         if (need_alloc > context->allocated) {
                 guint new_size = 1;
-                while (new_size < need_alloc)
-                        new_size *= 2;
+                while (new_size < need_alloc) {
+                        if (!_g_uint_checked_mul (&new_size, new_size, 2)) {
+                                new_size = 0;
+                                break;
+                        }
+                }
+
+                if (new_size == 0)
+                        return FALSE;
 
                 new_buffer = g_try_realloc (context->buffer, new_size);
                 if (new_buffer) {
