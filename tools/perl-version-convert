#! /usr/bin/ksh
#
#
# This file and its contents are supplied under the terms of the
# Common Development and Distribution License ("CDDL"), version 1.0.
# You may only use this file in accordance with the terms of version
# 1.0 of the CDDL.
#
# A full copy of the text of the CDDL should have accompanied this
# source.  A copy of the CDDL is also available via the Internet at
# http://www.illumos.org/license/CDDL.
#

#
# Copyright 2022 Marcel Telka
#


function usage
{
	[[ -n "$1" ]] && printf "ERROR: %s\n\n" "$1"
	printf "Usage: perl-version-convert MODULE VERSION\n" >&2
	[[ -n "$1" ]] && exit 1
	exit 0
}


(($# == 0)) && usage
(($# == 1)) && usage "Missing VERSION to convert"
(($# > 2)) && usage "Too much arguments"

MODULE="$1"
VERSION="$2"


function unsupported_version
{
	typeset -n C=$1
	typeset VERSION=$2

	printf "ERROR: Unsupported version format: %s\n" "$VERSION" >&2
	C="UNSUPPORTED_VERSION_FORMAT_$VERSION"
}

function convert_version
{
	typeset -n C=$1
	typeset MODULE=$2
	typeset VERSION=$3

	typeset -a VER

	#
	# Handle special cases
	#
	# Notes:
	#
	# (*) The actual version format for Crypt-PBKDF2 is 0.YYDDDR (YY -
	# year, DDD - day in year, R - release in the day) so it had to be
	# converted to 0.YY.DDD.R to be more accurate, but it was already
	# integrated as 0.YYDDDR, so we need to follow it for now, because
	# 0.YY.DDD.R would be considered older than 0.YYDDDR.  Possible
	# conversion of 0.YYDDDR to YY.DDD.R would cause problem in a case the
	# Crypt::PBKDF2 bump their major version.
	#
	# (*) Module-Build uses apparently version format 0.XXYY so it had to
	# be converted to 0.XX.YY, but it was already integrated as 0.XXYY, so
	# we need to follow it for now.
	#
	[[ "$MODULE" == "Crypt-PBKDF2" && "${VERSION:0:2}" == "0." ]] && ((${#VERSION} == 8)) && VER[1]=$((1${VERSION:2:6} - 1000000)) && VERSION=${VERSION:0:1}
	[[ "$MODULE" == "Email-Sender" && "${VERSION:0:2}" == "1." ]] && ((${#VERSION} == 8)) && VER[1]=${VERSION:2:1} && VER[2]=$((1${VERSION:3:5} - 100000)) && VERSION=${VERSION:0:1}
	[[ "$MODULE" == "Email-Sender" && "${VERSION:0:2}" != "0." && "${VERSION:3:2}" == "00" ]] && ((${#VERSION} == 5)) && VER[1]=${VERSION:2:1} && VERSION=${VERSION:0:1}
	[[ "$MODULE" == "Module-Build" ]] && ((${#VERSION} == 6)) && VER[1]=$((1${VERSION:2:4} - 10000)) && VERSION=${VERSION:0:1}
	[[ "$MODULE" == "Mozilla-CA" ]] && ((${#VERSION} == 8)) && VER[1]=$((1${VERSION:4:2} - 100)) && VER[2]=$((1${VERSION:6:2} - 100)) && VERSION=${VERSION:0:4}
	[[ "$MODULE" == "PkgConfig" && "${VERSION:4:3}" == "026" ]] && ((${#VERSION} == 7)) && VER[1]=$((1${VERSION:2:2} - 100)) && VERSION=${VERSION:0:1}

	C=
	VER[0]=${VERSION%%.*}

	if [[ "${VER[0]}" != "$VERSION" ]] ; then
		V=${VERSION#*.}

		# Currently we do not support underscore in version
		V=${V//*_*}

		case "$V" in
		?)	VER[1]=$V ;;
		??)	VER[1]=$((1$V - 100)) ;;
		?.?)	VER[1]=${V:0:1} && VER[2]=${V:2:1} ;;
		???)	VER[1]=$((1$V - 1000)) ;;
		?.??)	VER[1]=${V:0:1} && VER[2]=$((1${V:2:2} - 100)) ;;
		??.?)	VER[1]=$((1${V:0:2} - 100)) && VER[2]=${V:3:1} ;;
		????)	VER[1]=$((1${V:0:2} - 100)) && VER[2]=$((1${V:2:2} - 100)) ;;
		?.????)	unsupported_version C $VERSION ; return ;;
		??.???)	unsupported_version C $VERSION ; return ;;
		???.??)	unsupported_version C $VERSION ; return ;;
		????.?)	unsupported_version C $VERSION ; return ;;
		??????)	VER[1]=$((1${V:0:3} - 1000)) ; VER[2]=$((1${V:3:3} - 1000)) ;;
		*)	unsupported_version C $VERSION ; return ;;
		esac
	fi

	i=0
	while ((i < ${#VER[@]})) ; do
		((i > 0)) && C="$C."
		C="$C${VER[$i]}"
		i=$((i + 1))
	done
}


convert_version VER "${MODULE//::/-}" "$VERSION"
printf "%s\n" "$VER"
